<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estat√≠sticas de F. Lapa - F1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://www.formula1.com/favicon.ico" type="image/x-icon">
    <style>
        :root {
            --primary-color: #e10600;
            --secondary-color: #00d4ff;
            --background-dark: #101010;
            --surface-color: #1a1a1a;
            --text-color: #f5f5f5;
            --text-muted: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Roboto Mono', monospace; 
            background-color: var(--background-dark);
            color: var(--text-color); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding: 20px;
            overflow-x: hidden;
        }
        #particles-js { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container { max-width: 1200px; width: 100%; margin: 0 auto; position: relative; z-index: 1; padding: 10px; }
        h1 { text-align: center; font-family: 'Orbitron', sans-serif; font-weight: 900; color: var(--text-color); text-shadow: 0 0 15px rgba(225, 6, 0, 0.5); font-size: 2.2rem; margin-bottom: 30px; letter-spacing: 2.5px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .f1-logo { width: 80px; filter: drop-shadow(0 0 5px #fff); }
        h2 { font-family: 'Orbitron', sans-serif; color: var(--text-color); font-size: 1.5rem; margin: 40px 0 20px 0; text-transform: uppercase; letter-spacing: 1.2px; text-align: left; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; }
        h3.subsection-title { font-family: 'Orbitron', sans-serif; color: var(--text-muted); font-size: 1.2rem; text-align: center; margin: 30px 0 15px 0; letter-spacing: 1px; }

        .card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5); }

        .form-container h3, .stats-card h3 { font-family: 'Orbitron', sans-serif; color: var(--text-color); font-size: 1.3rem; margin-top:0; margin-bottom: 20px; text-transform: uppercase; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; border-bottom: none; padding-bottom: 0;}
        select, input[type="number"] { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #333; border-radius: 5px; background: #222; color: var(--text-color); font-size: 1rem; transition: all 0.3s ease; }
        select:focus, input[type="number"]:focus { border-color: var(--primary-color); box-shadow: 0 0 10px rgba(225, 6, 0, 0.4); outline: none; }
        .form-container label { font-size: 1rem; display: flex; align-items: center; gap: 8px; color: var(--text-muted); margin: 10px 0; }
        button { background: var(--primary-color); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 700; text-transform: uppercase; width: 100%; margin-top: 15px; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(225, 6, 0, 0.3); }
        button:hover { background: #fff; color: var(--primary-color); box-shadow: 0 0 25px rgba(225, 6, 0, 0.6); transform: scale(1.02) translateY(-2px); }
        
        /* --- ESTILOS PARA A NOVA LISTA DE CORRIDAS --- */
        .race-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .race-card.clickable:hover {
            background-color: rgba(225, 6, 0, 0.1);
            cursor: pointer;
        }
        .race-header {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-family: 'Orbitron', sans-serif;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .race-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            align-items: center;
        }
        .detail-item {
            text-align: center;
            font-size: 0.9rem;
        }
        .detail-item strong {
            display: block;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .detail-item .value {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .posicao-col.podium-gold { color: #ffd700; } .posicao-col.podium-silver { color: #c0c0c0; } .posicao-col.podium-bronze { color: #cd7f32; }
        .posicao-col.not-completed { font-style: italic; color: #666; }
        .flag { width: 25px; margin-right: 10px; border-radius: 3px; }
        .delete-btn { background: none; border: 1px solid #444; color: #888; padding: 8px 12px; font-size: 0.9rem; width: auto; margin: 0; border-radius: 5px; transition: all 0.3s ease; }
        .delete-btn:hover { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        
        .stats-card p, .stats-card li { margin: 12px 0; font-size: 1rem; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        .stats-card p:last-child, .stats-card li:last-child { border-bottom: none; }
        .stats-card p .value, .stats-card li .value { margin-left: auto; font-weight: 700; text-align: right; }
        .stats-card ul { list-style: none; padding: 0;}
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-button { background: transparent; border: 1px solid #444; color: var(--text-muted); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 1rem; text-transform: uppercase; transition: all 0.3s ease; }
        .tab-button:hover { background-color: #222; color: #fff; transform: translateY(-3px); }
        .tab-button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(225, 6, 0, 0.4); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .records-list { list-style: none; padding: 0; }
        .records-list li { background: rgba(0, 0, 0, 0.2); padding: 12px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid var(--primary-color); font-size: 1rem; }
        .records-list li strong { color: var(--secondary-color); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 16, 0.7); z-index: 1000; justify-content: center; align-items: center; padding: 10px; backdrop-filter: blur(8px); }
        .modal-content { animation: modalEnter 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        @keyframes modalEnter { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        #gpStats p { animation: itemFadeInUp 0.5s both; }
        #gpStats p:nth-child(1) { animation-delay: 0.2s; } #gpStats p:nth-child(2) { animation-delay: 0.25s; } #gpStats p:nth-child(3) { animation-delay: 0.3s; } #gpStats p:nth-child(4) { animation-delay: 0.35s; } #gpStats p:nth-child(5) { animation-delay: 0.4s; } #gpStats p:nth-child(6) { animation-delay: 0.45s; }
        @keyframes itemFadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-content #gpTitle {
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .close-btn {
            background: transparent;
            color: #888;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover { color: var(--primary-color); transform: rotate(90deg) scale(1.1); }
        
        @media (max-width: 900px) { .info-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            h1 {font-size: 1.8rem;} 
            .tab-button { font-size: 0.9rem; padding: 8px 15px; } 
            body { padding: 10px; }
            .race-details { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="container">
        <h1><img src="https://www.formula1.com/etc/designs/fom-website/images/f1_logo.svg" class="f1-logo" alt="F√≥rmula 1 Logo"></h1>
        <div class="tabs">
            <button class="tab-button active" data-tab="temporadas"><i class="fas fa-calendar-alt"></i> Temporadas</button>
            <button class="tab-button" data-tab="info"><i class="fas fa-user"></i> Informa√ß√µes</button>
            <button class="tab-button" data-tab="equipes"><i class="fas fa-users"></i> Equipes</button>
            <button class="tab-button" data-tab="recordes"><i class="fas fa-trophy"></i> Recordes</button>
        </div>

        <div id="info" class="tab-content card">
            <div class="info-grid">
                <div id="ficha-tecnica-container"></div>
                <div>
                    <h2><i class="fas fa-chart-bar"></i> Resumo Estat√≠stico</h2>
                    <select id="stats-selector"></select>
                    <div id="info-display-card" class="stats-card" style="margin-top: 15px; border: none; padding: 0; box-shadow: none;"></div>
                </div>
            </div>
        </div>

        <div id="temporadas" class="tab-content active">
             <div class="form-container card">
                <h3><i class="fas fa-plus-circle"></i> Adicionar Resultado</h3>
                <select id="temporada"></select>
                <select id="grandePremio"></select>
                <input type="number" id="posicao" placeholder="Posi√ß√£o (1-20 ou deixe vazio para N/C)" min="1" max="20">
                <label><input type="checkbox" id="pole"> <i class="fas fa-tachometer-alt"></i> Pole Position</label>
                <label><input type="checkbox" id="voltaMaisRapida"> <i class="fas fa-stopwatch"></i> Volta Mais R√°pida</label>
                <label><input type="checkbox" id="grandSlam"> <i class="fas fa-trophy"></i> Grand Slam</label>
                <input type="number" id="titulos" placeholder="T√≠tulos Mundiais (Opcional)" min="0">
                <button id="adicionarResultadoBtn">Adicionar Resultado</button>
            </div>

            <h2><i class="fas fa-list-ol"></i> Corridas da Temporada</h2>
            <div id="resultadosContainer">
                <h3 class="subsection-title">Resultados Salvos</h3>
                <div id="resultadosSalvosContainer"></div>
                <h3 class="subsection-title">Corridas Futuras</h3>
                <div id="proximasCorridasContainer"></div>
            </div>

        </div>

        <div id="equipes" class="tab-content">
            <h2><i class="fas fa-shield-alt"></i> Desempenho por Equipe</h2>
            <div id="team-stats-container" class="info-grid"></div>
        </div>

        <div id="recordes" class="tab-content">
             <h2><i class="fas fa-crown"></i> Maiores Recordes da F1</h2>
            <div class="card">
                 <ol class="records-list">
                    <li><strong>Mais t√≠tulos mundiais:</strong> 7 (Michael Schumacher, Lewis Hamilton)</li>
                    <li><strong>Mais vit√≥rias:</strong> 103 (Lewis Hamilton)</li>
                    <li><strong>Mais pole positions:</strong> 104 (Lewis Hamilton)</li>
                    <li><strong>Mais p√≥dios:</strong> 197 (Lewis Hamilton)</li>
                    <li><strong>Mais voltas mais r√°pidas:</strong> 77 (Michael Schumacher)</li>
                    <li><strong>Mais Grand Slams:</strong> 8 (Jim Clark)</li>
                    <li><strong>Mais Hat-Tricks:</strong> 22 (Michael Schumacher)</li>
                    <li><strong>Maior n√∫mero de corridas disputadas:</strong> 400+ (Fernando Alonso)</li>
                    <li><strong>Mais vit√≥rias consecutivas:</strong> 10 (Max Verstappen, 2023)</li>
                    <li><strong>Mais vit√≥rias em uma √∫nica temporada:</strong> 19 (Max Verstappen, 2023)</li>
                    <li><strong>Maior % de vit√≥rias na carreira:</strong> 32.26% (Juan Manuel Fangio)</li>
                    <li><strong>Campe√£o mundial mais jovem:</strong> Sebastian Vettel (23 anos, 134 dias)</li>
                    <li><strong>Campe√£o mundial mais velho:</strong> Juan Manuel Fangio (46 anos, 41 dias)</li>
                    <li><strong>Vencedor de GP mais jovem:</strong> Max Verstappen (18 anos, 228 dias)</li>
                    <li><strong>Pole position mais jovem:</strong> Sebastian Vettel (21 anos, 72 dias)</li>
                    <li><strong>Mais pontos na carreira:</strong> 4639.5 (Lewis Hamilton)</li>
                    <li><strong>Mais temp. com pelo menos uma vit√≥ria:</strong> 15 (Lewis Hamilton)</li>
                    <li><strong>Mais p√≥dios consecutivos:</strong> 19 (Michael Schumacher)</li>
                    <li><strong>Mais corridas na zona de pontua√ß√£o:</strong> 48 (Lewis Hamilton)</li>
                    <li><strong>Mais vit√≥rias no mesmo GP:</strong> 8 (Lewis Hamilton, Michael Schumacher)</li>
                </ol>
            </div>
        </div>
    </div>

    <div id="gpModal" class="modal">
        <div class="modal-content card">
            <div class="modal-header">
                <h3 id="gpTitle"></h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="gpStats" class="stats-card" style="border: none; padding: 0; box-shadow: none;"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        particlesJS('particles-js', {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.2,"random":true},"size":{"value":3,"random":true},"line_linked":{"enable":false},"move":{"enable":true,"speed":1,"direction":"none","random":true,"straight":false,"out_mode":"out"}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":false},"onclick":{"enable":false}}},"retina_detect":true});

        document.addEventListener("DOMContentLoaded", () => {
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.addEventListener('click', () => { tabs.forEach(item => item.classList.remove('active')); tabContents.forEach(content => content.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active'); }));

            const firebaseConfig = { apiKey: "AIzaSyA0OlEixa0paaC8w5vwXr3d8bdXHsTsk6Q", authDomain: "formula1-7ddf0.firebaseapp.com", projectId: "formula1-7ddf0", storageBucket: "formula1-7ddf0.firebasestorage.app", messagingSenderId: "1033180811650", appId: "1:1033180811650:web:9e315520430b36e4e8ff9b", measurementId: "G-Q8LEND18DW" };
            let db;
            try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } catch (error) { console.error("Erro ao inicializar Firebase:", error); }

            const countryFlags = { "Bahrein": "bh", "Ar√°bia Saudita": "sa", "Austr√°lia": "au", "Jap√£o": "jp", "China": "cn", "Miami": "us", "Em√≠lia-Romanha": "it", "M√¥naco": "mc", "Canad√°": "ca", "Espanha": "es", "√Åustria": "at", "Gr√£-Bretanha": "gb", "Hungria": "hu", "B√©lgica": "be", "Pa√≠ses Baixos": "nl", "It√°lia": "it", "Azerbaij√£o": "az", "Singapura": "sg", "Estados Unidos": "us", "M√©xico": "mx", "S√£o Paulo": "br", "Las Vegas": "us", "Catar": "qa", "Abu Dhabi": "ae" };
            const corridas = {
                "2024": [ { data: "2024-03-02", nome: "Grande Pr√™mio do Bahrein" }, { data: "2024-03-09", nome: "Grande Pr√™mio da Ar√°bia Saudita" }, { data: "2024-03-24", nome: "Grande Pr√™mio da Austr√°lia" }, { data: "2024-04-07", nome: "Grande Pr√™mio do Jap√£o" }, { data: "2024-04-21", nome: "Grande Pr√™mio da China" }, { data: "2024-05-05", nome: "Grande Pr√™mio de Miami" }, { data: "2024-05-19", nome: "Grande Pr√™mio da Em√≠lia-Romanha" }, { data: "2024-05-26", nome: "Grande Pr√™mio de M√¥naco" }, { data: "2024-06-09", nome: "Grande Pr√™mio do Canad√°" }, { data: "2024-06-23", nome: "Grande Pr√™mio da Espanha" }, { data: "2024-06-30", nome: "Grande Pr√™mio da √Åustria" }, { data: "2024-07-07", nome: "Grande Pr√™mio da Gr√£-Bretanha" }, { data: "2024-07-21", nome: "Grande Pr√™mio da Hungria" }, { data: "2024-07-28", nome: "Grande Pr√™mio da B√©lgica" }, { data: "2024-08-25", nome: "Grande Pr√™mio dos Pa√≠ses Baixos" }, { data: "2024-09-01", nome: "Grande Pr√™mio da It√°lia" }, { data: "2024-09-15", nome: "Grande Pr√™mio do Azerbaij√£o" }, { data: "2024-09-22", nome: "Grande Pr√™mio de Singapura" }, { data: "2024-10-20", nome: "Grande Pr√™mio dos Estados Unidos" }, { data: "2024-10-27", nome: "Grande Pr√™mio do M√©xico" }, { data: "2024-11-03", nome: "Grande Pr√™mio de S√£o Paulo" }, { data: "2024-11-23", nome: "Grande Pr√™mio de Las Vegas" }, { data: "2024-12-01", nome: "Grande Pr√™mio do Catar" }, { data: "2024-12-08", nome: "Grande Pr√™mio de Abu Dhabi" } ],
                "2023": [ { data: "2023-03-05", nome: "Grande Pr√™mio do Bahrein" }, { data: "2023-03-19", nome: "Grande Pr√™mio da Ar√°bia Saudita" }, { data: "2023-04-02", nome: "Grande Pr√™mio da Austr√°lia" }, { data: "2023-04-30", nome: "Grande Pr√™mio do Azerbaij√£o" }, { data: "2023-05-07", nome: "Grande Pr√™mio de Miami" }, { data: "2023-05-28", nome: "Grande Pr√™mio de M√¥naco" }, { data: "2023-06-04", nome: "Grande Pr√™mio da Espanha" }, { data: "2023-06-18", nome: "Grande Pr√™mio do Canad√°" }, { data: "2023-07-02", nome: "Grande Pr√™mio da √Åustria" }, { data: "2023-07-09", nome: "Grande Pr√™mio da Gr√£-Bretanha" }, { data: "2023-07-23", nome: "Grande Pr√™mio da Hungria" }, { data: "2023-07-30", nome: "Grande Pr√™mio da B√©lgica" }, { data: "2023-08-27", nome: "Grande Pr√™mio dos Pa√≠ses Baixos" }, { data: "2023-09-03", nome: "Grande Pr√™mio da It√°lia" }, { data: "2023-09-17", nome: "Grande Pr√™mio de Singapura" }, { data: "2023-09-24", nome: "Grande Pr√™mio do Jap√£o" }, { data: "2023-10-08", nome: "Grande Pr√™mio do Catar" }, { data: "2023-10-22", nome: "Grande Pr√™mio dos Estados Unidos" }, { data: "2023-10-29", nome: "Grande Pr√™mio do M√©xico" }, { data: "2023-11-05", nome: "Grande Pr√™mio de S√£o Paulo" }, { data: "2023-11-18", nome: "Grande Pr√™mio de Las Vegas" }, { data: "2023-11-26", nome: "Grande Pr√™mio de Abu Dhabi" } ]
            };
            
            const teamData = { 
                "2023": { name: "Alpine", logo: "https://upload.wikimedia.org/wikipedia/en/b/b3/Alpine_F1_Team_Logo_2023.png" }, 
                "2024": { name: "Mercedes", logo: "https://upload.wikimedia.org/wikipedia/commons/2/2f/Mercedes-AMG_Petronas_F1_Team_logo.png" }
            };

            const temporadaSelect = document.getElementById("temporada"), grandePremioSelect = document.getElementById("grandePremio"), adicionarResultadoBtn = document.getElementById("adicionarResultadoBtn"), statsSelector = document.getElementById('stats-selector'), infoDisplayCard = document.getElementById('info-display-card'), fichaTecnicaContainer = document.getElementById('ficha-tecnica-container'), teamStatsContainer = document.getElementById('team-stats-container'), gpModal = document.getElementById('gpModal'), gpTitle = document.getElementById('gpTitle'), gpStats = document.getElementById('gpStats'), closeBtn = document.querySelector('.close-btn');

            function calculateAge(birthDateString) { const [day, month, year] = birthDateString.split('/'); const birthDate = new Date(+year, +month - 1, +day); const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--; return age; }
            
            function displayFichaTecnica() { 
                const pilotInfo = { name: "Fernando Lapa", nationality: "Brasileiro", birthDate: "18/02/2005", birthPlace: "Florian√≥polis, SC" }; 
                const teamsList = Object.keys(teamData)
                    .sort((a,b) => b-a)
                    .map(year => `<li><i class="fas fa-users"></i> ${year}:<span class="value">${teamData[year].name}</span></li>`)
                    .join(''); 
                fichaTecnicaContainer.innerHTML = `<div class="stats-card"><h3><i class="fas fa-id-card"></i> Ficha T√©cnica</h3><ul><li><i class="fas fa-user"></i> Nome: <span class="value">${pilotInfo.name}</span></li><li><i class="fas fa-flag"></i> Nacionalidade: <span class="value">${pilotInfo.nationality}</span></li><li><i class="fas fa-birthday-cake"></i> Nascimento: <span class="value">${pilotInfo.birthDate} (${calculateAge(pilotInfo.birthDate)} anos)</span></li><li><i class="fas fa-map-marker-alt"></i> Naturalidade: <span class="value">${pilotInfo.birthPlace}</span></li></ul><h3 style="margin-top: 20px;"><i class="fas fa-history"></i> Hist√≥rico de Equipes</h3><ul>${teamsList}</ul></div>`; 
            }
            
            async function displayTeamStats() {
                if (!db) return;
                teamStatsContainer.innerHTML = `<p style="text-align: center;">Calculando estat√≠sticas...</p>`;
                try {
                    const allRacesSnapshot = await db.collection("corridas").get();
                    const aggregatedStats = {};
                    allRacesSnapshot.forEach(doc => {
                        const race = doc.data(); const teamInfo = teamData[race.temporada];
                        if (!teamInfo) return;
                        if (!aggregatedStats[teamInfo.name]) { aggregatedStats[teamInfo.name] = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0, titulos: 0, temporadas: 0, latestYear: 0 }; }
                        const stats = aggregatedStats[teamInfo.name];
                        stats.latestYear = Math.max(stats.latestYear, parseInt(race.temporada));
                        stats.corridas++; if (race.posicao === 1) stats.vitorias++; if (race.posicao >= 1 && race.posicao <= 3) stats.podios++; if (race.pole) stats.poles++; if (race.voltaMaisRapida) stats.voltasMaisRapidas++; if (race.grandSlam) stats.grandSlams++;
                    });

                    const teamYears = {};
                    for (const year in teamData) {
                        const teamName = teamData[year].name;
                        if (!teamYears[teamName]) teamYears[teamName] = [];
                        teamYears[teamName].push(year);
                    }
                    
                    const statsPromises = Object.keys(corridas).map(year => db.doc(`estatisticas/temporada_${year}`).get());
                    const statsDocs = await Promise.all(statsPromises);
                    const seasonTitles = {};
                    statsDocs.forEach(doc => {
                        if (doc.exists) {
                            const year = doc.id.split('_')[1];
                            seasonTitles[year] = doc.data().titulos || 0;
                        }
                    });

                    for (const teamName in aggregatedStats) {
                        const seasonsWithTeam = teamYears[teamName] || [];
                        aggregatedStats[teamName].temporadas = seasonsWithTeam.length;
                        let totalTitles = 0;
                        for (const year of seasonsWithTeam) {
                            if (seasonTitles[year]) {
                                totalTitles += seasonTitles[year];
                            }
                        }
                        aggregatedStats[teamName].titulos = totalTitles;
                    }
                    
                    let html = '';
                    const calcPct = (val, total) => total > 0 ? `(${(val / total * 100).toFixed(1)}%)` : '';
                    
                    const sortedTeamNames = Object.keys(aggregatedStats).sort((a, b) => aggregatedStats[b].latestYear - aggregatedStats[a].latestYear);

                    for (const teamName of sortedTeamNames) {
                        const stats = aggregatedStats[teamName];
                        let titulosPctTeam = "0.0";
                        if (stats.titulos > 0 && stats.temporadas > 0) {
                            titulosPctTeam = ((stats.titulos / stats.temporadas) * 100).toFixed(1);
                        }

                        html += `<div class="card stats-card"><h3>${teamName}</h3>
                            <p><i class="fas fa-calendar-alt"></i> Temporadas: <span class="value">${stats.temporadas}</span></p>
                            <p><i class="fas fa-flag-checkered"></i> Corridas: <span class="value">${stats.corridas}</span></p>
                            <p><i class="fas fa-trophy"></i> Vit√≥rias: <span class="value">${stats.vitorias} ${calcPct(stats.vitorias, stats.corridas)}</span></p>
                            <p><i class="fas fa-star"></i> P√≥dios: <span class="value">${stats.podios} ${calcPct(stats.podios, stats.corridas)}</span></p>
                            <p><i class="fas fa-award"></i> T√≠tulos: <span class="value">${stats.titulos} (${titulosPctTeam}%)</span></p>
                            <p><i class="fas fa-tachometer-alt"></i> Poles: <span class="value">${stats.poles} ${calcPct(stats.poles, stats.corridas)}</span></p>
                            <p><i class="fas fa-stopwatch"></i> V. R√°pidas: <span class="value">${stats.voltasMaisRapidas} ${calcPct(stats.voltasMaisRapidas, stats.corridas)}</span></p>
                            <p><i class="fas fa-crown"></i> Grand Slams: <span class="value">${stats.grandSlams} ${calcPct(stats.grandSlams, stats.corridas)}</span></p></div>`;
                    }
                    teamStatsContainer.innerHTML = html || '<p style="text-align: center;">Sem dados de equipe para exibir.</p>';
                } catch (error) { console.error("Erro ao exibir estat√≠sticas da equipe:", error); teamStatsContainer.innerHTML = `<p style="text-align: center;">Erro ao carregar os dados das equipes.</p>`; }
            }

            function populateSelectors() {
                temporadaSelect.innerHTML = '';
                Object.keys(corridas).sort((a,b) => b-a).forEach(ano => { const option = document.createElement("option"); option.value = ano; option.textContent = ano; temporadaSelect.appendChild(option); });
                statsSelector.innerHTML = '<option value="carreira">Carreira</option>';
                Object.keys(corridas).sort((a,b) => b-a).forEach(ano => { const option = document.createElement("option"); option.value = ano; option.textContent = `Temporada ${ano}`; statsSelector.appendChild(option); });
            }

            async function displaySelectedStats() {
                if (!db) return;
                const selection = statsSelector.value;
                let docPath, title;
                if (selection === 'carreira') { docPath = 'estatisticas/carreira'; title = 'Carreira'; } else { docPath = `estatisticas/temporada_${selection}`; title = `Temporada ${selection}`; }
                infoDisplayCard.innerHTML = `<p>Carregando...</p>`;
                try {
                    const doc = await db.doc(docPath).get();
                    if (doc.exists) {
                        const stats = doc.data();
                        let totalSeasons = Object.keys(corridas).length;
                        let titulosPct = "0.0";
                        if (stats.titulos > 0) { titulosPct = (selection === 'carreira') ? (stats.titulos / totalSeasons * 100).toFixed(1) : (stats.titulos / 1 * 100).toFixed(1); }
                        infoDisplayCard.innerHTML = `<h3>${title}</h3>
                            <p><i class="fas fa-flag-checkered"></i> Corridas: <span class="value">${stats.corridas || 0}</span></p>
                            <p><i class="fas fa-trophy"></i> Vit√≥rias: <span class="value">${stats.vitorias || 0} (${stats.vitoriasPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-star"></i> P√≥dios: <span class="value">${stats.podios || 0} (${stats.podiosPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-tachometer-alt"></i> Poles: <span class="value">${stats.poles || 0} (${stats.polesPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-stopwatch"></i> V. R√°pidas: <span class="value">${stats.voltasMaisRapidas || 0} (${stats.voltasMaisRapidasPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-crown"></i> Grand Slams: <span class="value">${stats.grandSlams || 0} (${stats.grandSlamsPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-award"></i> T√≠tulos: <span class="value">${stats.titulos || 0} (${titulosPct}%)</span></p>`;
                    } else { infoDisplayCard.innerHTML = `<h3>${title}</h3><p>Sem dados dispon√≠veis.</p>`; }
                } catch (error) { console.error("Erro ao buscar estat√≠sticas:", error); infoDisplayCard.innerHTML = `<h3>${title}</h3><p>Erro ao carregar estat√≠sticas.</p>`; }
            }
            
            function preencherGrandesPremios() {
                const temporada = temporadaSelect.value;
                grandePremioSelect.innerHTML = '<option value="">Selecione um GP</option>';
                if (corridas[temporada]) corridas[temporada].forEach(corrida => { const option = document.createElement("option"); option.value = corrida.nome; option.textContent = corrida.nome; grandePremioSelect.appendChild(option); });
                carregarResultadosDaTemporada();
            }
            
            async function carregarResultadosDaTemporada() {
                if (!db) return;
                const temporada = temporadaSelect.value;
                const resultadosSalvosContainer = document.getElementById('resultadosSalvosContainer');
                const proximasCorridasContainer = document.getElementById('proximasCorridasContainer');
                resultadosSalvosContainer.innerHTML = `<p style="padding: 20px 0; text-align: center;">Buscando resultados salvos...</p>`;
                proximasCorridasContainer.innerHTML = "";

                try {
                    const corridasSnapshot = await db.collection("corridas").where("temporada", "==", temporada).get();
                    const resultadosFirestore = [];
                    const nomesCorridasFirestore = new Set();
                    corridasSnapshot.forEach(doc => {
                        const data = doc.data();
                        resultadosFirestore.push(data);
                        nomesCorridasFirestore.add(data.grandePremio);
                    });

                    resultadosSalvosContainer.innerHTML = ""; 

                    if (resultadosFirestore.length === 0) {
                        resultadosSalvosContainer.innerHTML = "<p style='padding: 20px 0; text-align: center;'>Nenhum resultado adicionado para esta temporada.</p>";
                    } else {
                        resultadosFirestore.sort((a, b) => {
                            const raceDateA = corridas[temporada].find(r => r.nome === a.grandePremio)?.data || 0;
                            const raceDateB = corridas[temporada].find(r => r.nome === b.grandePremio)?.data || 0;
                            return new Date(raceDateA) - new Date(raceDateB);
                        });

                        resultadosFirestore.forEach(dados => {
                            const nomeCurto = dados.grandePremio.replace(/^(Grande Pr√™mio|GP) d(o|a|e|os|as)\s/, '');
                            const flagCode = countryFlags[nomeCurto] || 'xx';
                            const card = document.createElement("div");
                            card.className = "race-card clickable";
                            card.dataset.gp = dados.grandePremio;

                            let posicaoClass = '';
                            if (dados.posicao === 1) posicaoClass = 'podium-gold';
                            else if (dados.posicao === 2) posicaoClass = 'podium-silver';
                            else if (dados.posicao === 3) posicaoClass = 'podium-bronze';
                            else if (dados.posicao === "N/C") posicaoClass = 'not-completed';

                            card.innerHTML = `
                                <div class="race-header">
                                    <img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"> ${dados.grandePremio}
                                </div>
                                <div class="race-details">
                                    <div class="detail-item"><strong >Pos.</strong><span class="value posicao-col ${posicaoClass}">${dados.posicao}</span></div>
                                    <div class="detail-item"><strong >Pole</strong><span class="value">${dados.pole ? '<i class="fas fa-check" style="color: var(--secondary-color);"></i>' : '-'}</span></div>
                                    <div class="detail-item"><strong >V. R√°pida</strong><span class="value">${dados.voltaMaisRapida ? '<i class="fas fa-check" style="color: var(--secondary-color);"></i>' : '-'}</span></div>
                                    <div class="detail-item"><button class="delete-btn" data-temporada="${dados.temporada}" data-gp="${dados.grandePremio}"><i class="fas fa-trash"></i> Remover</button></div>
                                </div>
                            `;
                            resultadosSalvosContainer.appendChild(card);
                        });
                    }
                    
                    const calendarioTemporada = corridas[temporada] || [];
                    calendarioTemporada.forEach(corrida => {
                        if (!nomesCorridasFirestore.has(corrida.nome)) {
                            const nomeCurto = corrida.nome.replace(/^(Grande Pr√™mio|GP) d(o|a|e|os|as)\s/, '');
                            const flagCode = countryFlags[nomeCurto] || 'xx';
                            const card = document.createElement("div");
                            card.className = "race-card";

                            card.innerHTML = `
                                <div class="race-header">
                                    <img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"> ${corrida.nome}
                                </div>
                                <div class="race-details">
                                    <div class="detail-item" style="grid-column: 1 / -1; text-align:center; color: var(--text-muted);">Aguardando resultado...</div>
                                </div>
                            `;
                            proximasCorridasContainer.appendChild(card);
                        }
                    });
                    
                    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const { temporada, gp } = e.currentTarget.dataset; excluirResultado(temporada, gp); }));
                    document.querySelectorAll('.race-card.clickable').forEach(card => card.addEventListener('click', (e) => { if (!e.target.closest('.delete-btn')) { mostrarEstatisticasGP(e.currentTarget.dataset.gp); }}));
                } catch (error) { console.error("Erro Cr√≠tico ao carregar resultados:", error); resultadosSalvosContainer.innerHTML = `<p>Erro ao carregar dados.</p>`; }
            }

            async function mostrarEstatisticasGP(grandePremio) {
                if (!db) return;
                const nomeCurto = grandePremio.replace(/^(Grande Pr√™mio|GP) d(o|a|e|os|as)\s/, '');
                const flagCode = countryFlags[nomeCurto] || 'xx';
                gpTitle.innerHTML = `<img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"> ${grandePremio}`;
                gpStats.innerHTML = `<p>Buscando dados...</p>`;
                gpModal.style.display = "flex";
                try {
                    const gpSnapshot = await db.collection('corridas').where('grandePremio', '==', grandePremio).get();
                    let stats = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0 };
                    gpSnapshot.forEach(doc => {
                        const d = doc.data(); stats.corridas++;
                        if(d.posicao === 1) stats.vitorias++; if(d.posicao >= 1 && d.posicao <= 3) stats.podios++; if(d.pole) stats.poles++; if(d.voltaMaisRapida) stats.voltasMaisRapidas++; if(d.grandSlam) stats.grandSlams++;
                    });
                    gpStats.innerHTML = `<p><i class="fas fa-flag-checkered"></i> Corridas: <span class="value">${stats.corridas}</span></p>
                                        <p><i class="fas fa-trophy"></i> Vit√≥rias: <span class="value">${stats.vitorias}</span></p>
                                        <p><i class="fas fa-star"></i> P√≥dios: <span class="value">${stats.podios}</span></p>
                                        <p><i class="fas fa-tachometer-alt"></i> Poles: <span class="value">${stats.poles}</span></p>
                                        <p><i class="fas fa-stopwatch"></i> V. R√°pidas: <span class="value">${stats.voltasMaisRapidas}</span></p>
                                        <p><i class="fas fa-crown"></i> Grand Slams: <span class="value">${stats.grandSlams}</span></p>`;
                } catch(error) { gpStats.innerHTML = `<p>Erro ao carregar estat√≠sticas do GP.</p>`; }
            }

            function limparFormulario() { document.getElementById("posicao").value = ""; document.getElementById("pole").checked = false; document.getElementById("voltaMaisRapida").checked = false; document.getElementById("grandSlam").checked = false; document.getElementById("titulos").value = ""; }
            async function adicionarResultado() {
                const temporada = temporadaSelect.value, grandePremio = grandePremioSelect.value, posicaoInput = document.getElementById("posicao").value, posicao = posicaoInput ? parseInt(posicaoInput) : "N/C", pole = document.getElementById("pole").checked, voltaMaisRapida = document.getElementById("voltaMaisRapida").checked, grandSlam = document.getElementById("grandSlam").checked, titulos = document.getElementById("titulos").value !== "" ? parseInt(document.getElementById("titulos").value) : null;
                if (!temporada || !grandePremio) { alert("Selecione uma temporada e um GP."); return; }
                const dadosCorrida = { temporada, grandePremio, posicao, pole, voltaMaisRapida, grandSlam };
                if (!db) return;
                try { await db.collection("corridas").doc(`${temporada}_${grandePremio}`).set(dadosCorrida); await atualizarEstatisticas(temporada, titulos); limparFormulario(); carregarResultadosDaTemporada(); displaySelectedStats(); displayTeamStats(); } catch (error) { console.error("Erro ao adicionar resultado:", error); alert("Falha ao adicionar resultado."); }
            }
            async function excluirResultado(temporada, grandePremio) {
                if (!db) return;
                if (confirm(`Deseja excluir o resultado de ${grandePremio} (${temporada})?`)) { 
                    try { await db.collection("corridas").doc(`${temporada}_${grandePremio}`).delete(); await atualizarEstatisticas(temporada, null); carregarResultadosDaTemporada(); displaySelectedStats(); displayTeamStats(); } catch (error) { console.error("Erro ao excluir resultado:", error); alert("Falha ao excluir resultado."); } 
                }
            }
            async function atualizarEstatisticas(temporada, titulos) {
                if (!db) return;
                try {
                    const corridasSnapshot = await db.collection("corridas").where("temporada", "==", temporada).get();
                    let estac = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0, titulos: 0 };
                    corridasSnapshot.forEach(doc => { const d = doc.data(); estac.corridas++; if (d.posicao === 1) estac.vitorias++; if (d.posicao >= 1 && d.posicao <= 3) estac.podios++; if (d.pole) estac.poles++; if (d.voltaMaisRapida) estac.voltasMaisRapidas++; if(d.grandSlam) estac.grandSlams++; });
                    if (titulos !== null) { estac.titulos = titulos; } else { const statsDoc = await db.collection("estatisticas").doc(`temporada_${temporada}`).get(); if (statsDoc.exists) estac.titulos = statsDoc.data().titulos || 0; }
                    const calcPct = (val, total) => total > 0 ? ((val / total) * 100).toFixed(1) : "0.0";
                    estac.vitoriasPct = calcPct(estac.vitorias, estac.corridas); estac.podiosPct = calcPct(estac.podios, estac.corridas); estac.polesPct = calcPct(estac.poles, estac.corridas); estac.voltasMaisRapidasPct = calcPct(estac.voltasMaisRapidas, estac.corridas); estac.grandSlamsPct = calcPct(estac.grandSlams, estac.corridas);
                    await db.collection("estatisticas").doc(`temporada_${temporada}`).set(estac, { merge: true });
                    const todasCorridas = await db.collection("corridas").get();
                    let estacCarreira = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0, titulos: 0 };
                    let titulosCarreira = 0;
                    todasCorridas.forEach(doc => { const d = doc.data(); estacCarreira.corridas++; if (d.posicao === 1) estacCarreira.vitorias++; if (d.posicao >= 1 && d.posicao <= 3) estacCarreira.podios++; if (d.pole) estacCarreira.poles++; if (d.voltaMaisRapida) estacCarreira.voltasMaisRapidas++; if(d.grandSlam) estacCarreira.grandSlams++; });
                    for (const temp of Object.keys(corridas)) { const temporadaDoc = await db.collection("estatisticas").doc(`temporada_${temp}`).get(); if (temporadaDoc.exists) titulosCarreira += temporadaDoc.data().titulos || 0; }
                    estacCarreira.titulos = titulosCarreira;
                    estacCarreira.vitoriasPct = calcPct(estacCarreira.vitorias, estacCarreira.corridas); estacCarreira.podiosPct = calcPct(estacCarreira.podios, estacCarreira.corridas); estacCarreira.polesPct = calcPct(estacCarreira.poles, estacCarreira.corridas); estacCarreira.voltasMaisRapidasPct = calcPct(estacCarreira.voltasMaisRapidas, estacCarreira.corridas); estacCarreira.grandSlamsPct = calcPct(estacCarreira.grandSlams, estacCarreira.corridas);
                    await db.collection("estatisticas").doc("carreira").set(estacCarreira, { merge: true });
                } catch (error) { console.error("Erro ao atualizar estat√≠sticas:", error); }
            }
            
            closeBtn.addEventListener('click', () => { gpModal.style.display = 'none'; });
            window.addEventListener('click', (e) => { if (e.target === gpModal) { gpModal.style.display = 'none'; } });

            document.querySelectorAll('.card').forEach(card => { card.onmousemove = e => { const rect = card.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top; card.style.setProperty('--mouse-x', `${x}px`); card.style.setProperty('--mouse-y', `${y}px`); }; });

            // INICIALIZA√á√ÉO DA P√ÅGINA
            displayFichaTecnica(); populateSelectors(); preencherGrandesPremios(); displaySelectedStats(); displayTeamStats();
            
            // LISTENERS DE EVENTOS
            temporadaSelect.addEventListener("change", preencherGrandesPremios);
            adicionarResultadoBtn.addEventListener("click", adicionarResultado);
            statsSelector.addEventListener('change', displaySelectedStats);
        });
    </script>
</body>
</html>

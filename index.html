<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estat√≠sticas de F. Lapa - F1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://www.formula1.com/favicon.ico" type="image/x-icon">
    <style>
        :root {
            --primary-color: #e10600;
            --secondary-color: #00d4ff;
            --background-dark: #101010;
            --surface-color: #1a1a1a;
            --text-color: #f5f5f5;
            --text-muted: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Roboto Mono', monospace; 
            background-color: var(--background-dark);
            color: var(--text-color); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding: 20px;
            overflow-x: hidden;
        }
        #particles-js { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container { max-width: 1200px; width: 100%; margin: 0 auto; position: relative; z-index: 1; padding: 10px; }
        h1 { text-align: center; font-family: 'Orbitron', sans-serif; font-weight: 900; color: var(--text-color); text-shadow: 0 0 15px rgba(225, 6, 0, 0.5); font-size: 2.2rem; margin-bottom: 30px; letter-spacing: 2.5px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .f1-logo { width: 80px; filter: drop-shadow(0 0 5px #fff); }
        h2 { font-family: 'Orbitron', sans-serif; color: var(--text-color); font-size: 1.5rem; margin: 40px 0 20px 0; text-transform: uppercase; letter-spacing: 1.2px; text-align: left; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; }
        h3.subsection-title { font-family: 'Orbitron', sans-serif; color: var(--text-muted); font-size: 1.2rem; text-align: center; margin: 30px 0 15px 0; letter-spacing: 1px; }
        
        .card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5); }

        .form-container h3, .stats-card h3 { font-family: 'Orbitron', sans-serif; color: var(--text-color); font-size: 1.3rem; margin-top:0; margin-bottom: 20px; text-transform: uppercase; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; border-bottom: none; padding-bottom: 0;}
        select, input[type="number"] { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #333; border-radius: 5px; background: #222; color: var(--text-color); font-size: 1rem; transition: all 0.3s ease; }
        select:focus, input[type="number"]:focus { border-color: var(--primary-color); box-shadow: 0 0 10px rgba(225, 6, 0, 0.4); outline: none; }
        .form-container label { font-size: 1rem; display: flex; align-items: center; gap: 8px; color: var(--text-muted); margin: 10px 0; }
        button { background: var(--primary-color); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 700; text-transform: uppercase; width: 100%; margin-top: 15px; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(225, 6, 0, 0.3); }
        button:hover { background: #fff; color: var(--primary-color); box-shadow: 0 0 25px rgba(225, 6, 0, 0.6); transform: scale(1.02) translateY(-2px); }
        
        #classificacao-botao-container { text-align: center; margin: -10px 0 25px 0; }
        #classificacao-botao-container button { width: auto; font-size: 0.9rem; padding: 10px 20px; }

        .race-card {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .race-card:hover {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .race-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.2rem;
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 15px;
        }
        .race-header-title { display: flex; align-items: center; }
        .race-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            align-items: center;
        }
        .detail-item {
            text-align: center;
            font-size: 0.9rem;
        }
        .detail-item strong {
            display: block;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .detail-item .value { font-size: 1.2rem; font-weight: 700; }
        .posicao-col.podium-gold { color: #ffd700; } .posicao-col.podium-silver { color: #c0c0c0; } .posicao-col.podium-bronze { color: #cd7f32; }
        .posicao-col.not-completed { font-style: italic; color: #666; }
        .flag { width: 25px; margin-right: 10px; border-radius: 3px; vertical-align: middle; }
        .delete-btn, .ver-resultado-btn { background: none; border: 1px solid #444; color: #888; padding: 8px 12px; font-size: 0.9rem; width: auto; margin: 0; border-radius: 5px; transition: all 0.3s ease; }
        .delete-btn:hover, .ver-resultado-btn:hover { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .ver-resultado-btn { border-color: var(--secondary-color); color: var(--secondary-color); }
        .ver-resultado-btn:hover { background-color: var(--secondary-color); color: #101010;}

        table { width: 100%; border-collapse: collapse; color: var(--text-color); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; vertical-align: middle; }
        th { background: none; border-bottom-width: 2px; color: var(--text-muted); font-family: 'Orbitron', sans-serif; text-transform: uppercase; }
        tr { transition: background-color 0.3s ease; }
        .destaque-piloto { background-color: rgba(225, 6, 0, 0.2); }
        
        .stats-card p, .stats-card li { margin: 12px 0; font-size: 1rem; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        .stats-card p:last-child, .stats-card li:last-child { border-bottom: none; }
        .stats-card p .value, .stats-card li .value { margin-left: auto; font-weight: 700; text-align: right; }
        .stats-card ul { list-style: none; padding: 0;}
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-button { background: transparent; border: 1px solid #444; color: var(--text-muted); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 1rem; text-transform: uppercase; transition: all 0.3s ease; }
        .tab-button:hover { background-color: #222; color: #fff; transform: translateY(-3px); }
        .tab-button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(225, 6, 0, 0.4); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .records-list { list-style: none; padding: 0; }
        .records-list li { background: rgba(0, 0, 0, 0.2); padding: 12px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid var(--primary-color); font-size: 1rem; }
        .records-list li strong { color: var(--secondary-color); }
        
        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 16, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
            backdrop-filter: blur(8px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0s 0.4s;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease;
        }
        .modal-content {
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), opacity 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .modal.open .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        #gpStats p { animation: itemFadeInUp 0.5s both; }
        #gpStats p:nth-child(1) { animation-delay: 0.2s; } #gpStats p:nth-child(2) { animation-delay: 0.25s; } #gpStats p:nth-child(3) { animation-delay: 0.3s; }
        @keyframes itemFadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-content #gpTitle, .modal-content #classificacaoTitle, .modal-content #raceGridTitle {
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .close-btn {
            background: transparent;
            color: #888;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover { color: var(--primary-color); transform: rotate(90deg) scale(1.1); }
        
        #classificacaoModalContainer, #raceGridModalContainer {
            overflow-x: auto;
        }
        
        @media (max-width: 900px) { .info-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            h1 {font-size: 1.8rem;} 
            .tab-button { font-size: 0.9rem; padding: 8px 15px; } 
            body { padding: 10px; }
            .race-details { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="container">
        <h1><img src="https://www.formula1.com/etc/designs/fom-website/images/f1_logo.svg" class="f1-logo" alt="F√≥rmula 1 Logo"></h1>
        <div class="tabs">
            <button class="tab-button active" data-tab="temporadas"><i class="fas fa-calendar-alt"></i> Temporadas</button>
            <button class="tab-button" data-tab="info"><i class="fas fa-user"></i> Informa√ß√µes</button>
            <button class="tab-button" data-tab="equipes"><i class="fas fa-users"></i> Equipes</button>
            <button class="tab-button" data-tab="recordes"><i class="fas fa-trophy"></i> Recordes</button>
        </div>

        <div id="info" class="tab-content card">
            <div class="info-grid">
                <div id="ficha-tecnica-container"></div>
                <div>
                    <h2><i class="fas fa-chart-bar"></i> Resumo Estat√≠stico</h2>
                    <select id="stats-selector"></select>
                    <div id="info-display-card" class="stats-card" style="margin-top: 15px; border: none; padding: 0; box-shadow: none;"></div>
                </div>
            </div>
        </div>

        <div id="temporadas" class="tab-content active">
             <div class="form-container card">
                <h3><i class="fas fa-plus-circle"></i> Adicionar Resultado</h3>
                <select id="temporada"></select>
                <select id="grandePremio"></select>
                <input type="number" id="posicao" placeholder="Posi√ß√£o (1-20 ou deixe vazio para N/C)" min="1" max="20">
                <label><input type="checkbox" id="pole"> <i class="fas fa-tachometer-alt"></i> Pole Position</label>
                <label><input type="checkbox" id="voltaMaisRapida"> <i class="fas fa-stopwatch"></i> Volta Mais R√°pida</label>
                <label><input type="checkbox" id="grandSlam"> <i class="fas fa-trophy"></i> Grand Slam</label>
                <input type="number" id="titulos" placeholder="T√≠tulos Mundiais (Opcional)" min="0">
                <button id="adicionarResultadoBtn">Adicionar Resultado</button>
            </div>
            
            <h2><i class="fas fa-list-ol"></i> Corridas da Temporada</h2>
            <div id="classificacao-botao-container"></div>
            <div id="resultadosContainer"></div>
        </div>

        <div id="equipes" class="tab-content">
            <h2><i class="fas fa-shield-alt"></i> Desempenho por Equipe</h2>
            <div id="team-stats-container" class="info-grid"></div>
        </div>

        <div id="recordes" class="tab-content">
             <h2><i class="fas fa-crown"></i> Maiores Recordes da F1</h2>
            <div class="card">
                 <ol class="records-list">
                    <li><strong>Mais t√≠tulos mundiais:</strong> 7 (Michael Schumacher, Lewis Hamilton)</li>
                    <li><strong>Mais vit√≥rias:</strong> 103 (Lewis Hamilton)</li>
                    <li><strong>Mais pole positions:</strong> 104 (Lewis Hamilton)</li>
                    <li><strong>Mais p√≥dios:</strong> 197 (Lewis Hamilton)</li>
                    <li><strong>Mais voltas mais r√°pidas:</strong> 77 (Michael Schumacher)</li>
                    <li><strong>Mais Grand Slams:</strong> 8 (Jim Clark)</li>
                    <li><strong>Mais Hat-Tricks:</strong> 22 (Michael Schumacher)</li>
                    <li><strong>Maior n√∫mero de corridas disputadas:</strong> 400+ (Fernando Alonso)</li>
                    <li><strong>Mais vit√≥rias consecutivas:</strong> 10 (Max Verstappen, 2023)</li>
                    <li><strong>Mais vit√≥rias em uma √∫nica temporada:</strong> 19 (Max Verstappen, 2023)</li>
                    <li><strong>Maior % de vit√≥rias na carreira:</strong> 32.26% (Juan Manuel Fangio)</li>
                    <li><strong>Campe√£o mundial mais jovem:</strong> Sebastian Vettel (23 anos, 134 dias)</li>
                    <li><strong>Campe√£o mundial mais velho:</strong> Juan Manuel Fangio (46 anos, 41 dias)</li>
                    <li><strong>Vencedor de GP mais jovem:</strong> Max Verstappen (18 anos, 228 dias)</li>
                    <li><strong>Pole position mais jovem:</strong> Sebastian Vettel (21 anos, 72 dias)</li>
                    <li><strong>Mais pontos na carreira:</strong> 4639.5 (Lewis Hamilton)</li>
                    <li><strong>Mais temp. com pelo menos uma vit√≥ria:</strong> 15 (Lewis Hamilton)</li>
                    <li><strong>Mais p√≥dios consecutivos:</strong> 19 (Michael Schumacher)</li>
                    <li><strong>Mais corridas na zona de pontua√ß√£o:</strong> 48 (Lewis Hamilton)</li>
                    <li><strong>Mais vit√≥rias no mesmo GP:</strong> 8 (Lewis Hamilton, Michael Schumacher)</li>
                </ol>
            </div>
        </div>
    </div>

    <div id="gpStatsModal" class="modal">
        <div class="modal-content card">
            <div class="modal-header">
                <h3 id="gpTitle"></h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="gpStats" class="stats-card" style="border: none; padding: 0; box-shadow: none;"></div>
        </div>
    </div>

    <div id="classificacaoModal" class="modal">
        <div class="modal-content card">
             <div class="modal-header">
                <h3 id="classificacaoTitle"><i class="fas fa-trophy"></i> Classifica√ß√£o Final 2023</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="classificacaoModalContainer"></div>
        </div>
    </div>

    <div id="raceGridModal" class="modal">
        <div class="modal-content card">
             <div class="modal-header">
                <h3 id="raceGridTitle"></h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="raceGridModalContainer"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        particlesJS('particles-js', {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.2,"random":true},"size":{"value":3,"random":true},"line_linked":{"enable":false},"move":{"enable":true,"speed":1,"direction":"none","random":true,"straight":false,"out_mode":"out"}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":false},"onclick":{"enable":false}}},"retina_detect":true});

        document.addEventListener("DOMContentLoaded", () => {
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.addEventListener('click', () => { tabs.forEach(item => item.classList.remove('active')); tabContents.forEach(content => content.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active'); }));

            const firebaseConfig = { apiKey: "AIzaSyA0OlEixa0paaC8w5vwXr3d8bdXHsTsk6Q", authDomain: "formula1-7ddf0.firebaseapp.com", projectId: "formula1-7ddf0", storageBucket: "formula1-7ddf0.firebasestorage.app", messagingSenderId: "1033180811650", appId: "1:1033180811650:web:9e315520430b36e4e8ff9b", measurementId: "G-Q8LEND18DW" };
            let db;
            try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } catch (error) { console.error("Erro ao inicializar Firebase:", error); }

            const countryFlags = { "Bahrein": "bh", "Ar√°bia Saudita": "sa", "Austr√°lia": "au", "Jap√£o": "jp", "China": "cn", "Miami": "us", "Em√≠lia-Romanha": "it", "M√¥naco": "mc", "Canad√°": "ca", "Espanha": "es", "√Åustria": "at", "Gr√£-Bretanha": "gb", "Hungria": "hu", "B√©lgica": "be", "Pa√≠ses Baixos": "nl", "It√°lia": "it", "Azerbaij√£o": "az", "Singapura": "sg", "Estados Unidos": "us", "M√©xico": "mx", "S√£o Paulo": "br", "Las Vegas": "us", "Catar": "qa", "Abu Dhabi": "ae" };
            const corridas = {
                "2024": [ { data: "2024-03-02", nome: "Grande Pr√™mio do Bahrein" }, { data: "2024-03-09", nome: "Grande Pr√™mio da Ar√°bia Saudita" }, { data: "2024-03-24", nome: "Grande Pr√™mio da Austr√°lia" }, { data: "2024-04-07", nome: "Grande Pr√™mio do Jap√£o" }, { data: "2024-04-21", nome: "Grande Pr√™mio da China" }, { data: "2024-05-05", nome: "Grande Pr√™mio de Miami" }, { data: "2024-05-19", nome: "Grande Pr√™mio da Em√≠lia-Romanha" }, { data: "2024-05-26", nome: "Grande Pr√™mio de M√¥naco" }, { data: "2024-06-09", nome: "Grande Pr√™mio do Canad√°" }, { data: "2024-06-23", nome: "Grande Pr√™mio da Espanha" }, { data: "2024-06-30", nome: "Grande Pr√™mio da √Åustria" }, { data: "2024-07-07", nome: "Grande Pr√™mio da Gr√£-Bretanha" }, { data: "2024-07-21", nome: "Grande Pr√™mio da Hungria" }, { data: "2024-07-28", nome: "Grande Pr√™mio da B√©lgica" }, { data: "2024-08-25", nome: "Grande Pr√™mio dos Pa√≠ses Baixos" }, { data: "2024-09-01", nome: "Grande Pr√™mio da It√°lia" }, { data: "2024-09-15", nome: "Grande Pr√™mio do Azerbaij√£o" }, { data: "2024-09-22", nome: "Grande Pr√™mio de Singapura" }, { data: "2024-10-20", nome: "Grande Pr√™mio dos Estados Unidos" }, { data: "2024-10-27", nome: "Grande Pr√™mio do M√©xico" }, { data: "2024-11-03", nome: "Grande Pr√™mio de S√£o Paulo" }, { data: "2024-11-23", nome: "Grande Pr√™mio de Las Vegas" }, { data: "2024-12-01", nome: "Grande Pr√™mio do Catar" }, { data: "2024-12-08", nome: "Grande Pr√™mio de Abu Dhabi" } ],
                "2023": [ { data: "2023-03-05", nome: "Grande Pr√™mio do Bahrein" }, { data: "2023-03-19", nome: "Grande Pr√™mio da Ar√°bia Saudita" }, { data: "2023-04-02", nome: "Grande Pr√™mio da Austr√°lia" }, { data: "2023-04-30", nome: "Grande Pr√™mio do Azerbaij√£o" }, { data: "2023-05-07", nome: "Grande Pr√™mio de Miami" }, { data: "2023-05-28", nome: "Grande Pr√™mio de M√¥naco" }, { data: "2023-06-04", nome: "Grande Pr√™mio da Espanha" }, { data: "2023-06-18", nome: "Grande Pr√™mio do Canad√°" }, { data: "2023-07-02", nome: "Grande Pr√™mio da √Åustria" }, { data: "2023-07-09", nome: "Grande Pr√™mio da Gr√£-Bretanha" }, { data: "2023-07-23", nome: "Grande Pr√™mio da Hungria" }, { data: "2023-07-30", nome: "Grande Pr√™mio da B√©lgica" }, { data: "2023-08-27", nome: "Grande Pr√™mio dos Pa√≠ses Baixos" }, { data: "2023-09-03", nome: "Grande Pr√™mio da It√°lia" }, { data: "2023-09-17", nome: "Grande Pr√™mio de Singapura" }, { data: "2023-09-24", nome: "Grande Pr√™mio do Jap√£o" }, { data: "2023-10-08", nome: "Grande Pr√™mio do Catar" }, { data: "2023-10-22", nome: "Grande Pr√™mio dos Estados Unidos" }, { data: "2023-10-29", nome: "Grande Pr√™mio do M√©xico" }, { data: "2023-11-05", nome: "Grande Pr√™mio de S√£o Paulo" }, { data: "2023-11-18", nome: "Grande Pr√™mio de Las Vegas" }, { data: "2023-11-26", nome: "Grande Pr√™mio de Abu Dhabi" } ]
            };
            
            const teamData = { 
                "2023": { name: "Alpine", logo: "https://upload.wikimedia.org/wikipedia/en/b/b3/Alpine_F1_Team_Logo_2023.png" }, 
                "2024": { name: "Mercedes", logo: "https://upload.wikimedia.org/wikipedia/commons/2/2f/Mercedes-AMG_Petronas_F1_Team_logo.png" }
            };

            const pilotoNacionalidade = {
                "Fernando Lapa": "br", "Max Verstappen": "nl", "Sergio P√©rez": "mx", "Lewis Hamilton": "gb", "George Russell": "gb", "Charles Leclerc": "mc", "Carlos Sainz": "es", "Lando Norris": "gb", "Oscar Piastri": "au", "Pierre Gasly": "fr", "Alexander Albon": "th", "Fernando Alonso": "es", "Lance Stroll": "ca", "Valtteri Bottas": "fi", "Guanyu Zhou": "cn", "Yuki Tsunoda": "jp", "Daniel Ricciardo": "au", "Liam Lawson": "nz", "Nico H√ºlkenberg": "de", "Kevin Magnussen": "dk", "Logan Sargeant": "us"
            };
            const pilotos2023 = {
                "LAP": { "nome": "Fernando Lapa", "equipe": "Alpine" }, "VER": { "nome": "Max Verstappen", "equipe": "Red Bull" }, "PER": { "nome": "Sergio P√©rez", "equipe": "Red Bull" }, "HAM": { "nome": "Lewis Hamilton", "equipe": "Mercedes" }, "ALO": { "nome": "Fernando Alonso", "equipe": "Aston Martin" }, "LEC": { "nome": "Charles Leclerc", "equipe": "Ferrari" }, "SAI": { "nome": "Carlos Sainz", "equipe": "Ferrari" }, "NOR": { "nome": "Lando Norris", "equipe": "McLaren" }, "RUS": { "nome": "George Russell", "equipe": "Mercedes" }, "PIA": { "nome": "Oscar Piastri", "equipe": "McLaren" }, "STR": { "nome": "Lance Stroll", "equipe": "Aston Martin" }, "GAS": { "nome": "Pierre Gasly", "equipe": "Alpine" }, "ALB": { "nome": "Alexander Albon", "equipe": "Williams" }, "TSU": { "nome": "Yuki Tsunoda", "equipe": "AlphaTauri" }, "BOT": { "nome": "Valtteri Bottas", "equipe": "Alfa Romeo" }, "HUL": { "nome": "Nico H√ºlkenberg", "equipe": "Haas" }, "RIC": { "nome": "Daniel Ricciardo", "equipe": "AlphaTauri" }, "ZHO": { "nome": "Guanyu Zhou", "equipe": "Alfa Romeo" }, "MAG": { "nome": "Kevin Magnussen", "equipe": "Haas" }, "SAR": { "nome": "Logan Sargeant", "equipe": "Williams" }, "LAW": { "nome": "Liam Lawson", "equipe": "AlphaTauri" }
            };
            const classificacaoReal2023 = [
                { "piloto": "Max Verstappen", "pontos": 575 }, { "piloto": "Sergio P√©rez", "pontos": 285 }, { "piloto": "Lewis Hamilton", "pontos": 234 }, { "piloto": "Fernando Alonso", "pontos": 206 }, { "piloto": "Charles Leclerc", "pontos": 206 }, { "piloto": "Lando Norris", "pontos": 205 }, { "piloto": "Carlos Sainz", "pontos": 200 }, { "piloto": "George Russell", "pontos": 175 }, { "piloto": "Oscar Piastri", "pontos": 97 }, { "piloto": "Lance Stroll", "pontos": 74 }, { "piloto": "Pierre Gasly", "pontos": 62 }, { "piloto": "Alexander Albon", "pontos": 27 }, { "piloto": "Yuki Tsunoda", "pontos": 17 }, { "piloto": "Valtteri Bottas", "pontos": 10 }, { "piloto": "Nico H√ºlkenberg", "pontos": 9 }, { "piloto": "Daniel Ricciardo", "pontos": 6 }, { "piloto": "Guanyu Zhou", "pontos": 6 }, { "piloto": "Kevin Magnussen", "pontos": 3 }, { "piloto": "Liam Lawson", "pontos": 2 }, { "piloto": "Logan Sargeant", "pontos": 1 }
            ];
            const resultadosReais2023 = {
                "Grande Pr√™mio do Bahrein": { grid: ["VER", "PER", "ALO", "SAI", "HAM", "STR", "RUS", "BOT", "GAS", "ALB", "TSU", "SAR", "MAG", "DEV", "HUL", "ZHO", "NOR"], voltaRapida: "ZHO" },
                "Grande Pr√™mio da Ar√°bia Saudita": { grid: ["PER", "VER", "ALO", "RUS", "HAM", "SAI", "LEC", "GAS", "MAG", "TSU", "HUL", "ZHO", "PIA", "SAR", "NOR", "BOT", "ALB", "STR"], voltaRapida: "VER" },
                "Grande Pr√™mio da Austr√°lia": { grid: ["VER", "HAM", "ALO", "STR", "PER", "NOR", "HUL", "PIA", "ZHO", "TSU", "BOT", "SAI", "GAS", "MAG", "DEV", "SAR", "RUS", "ALB"], voltaRapida: "PER" },
                "Grande Pr√™mio do Azerbaij√£o": { sprint: ["PER", "LEC", "VER", "RUS", "SAI", "ALO", "HAM", "ALB"], grid: ["PER", "LEC", "VER", "ALO", "SAI", "HAM", "STR", "RUS", "NOR", "HUL", "PIA", "ZHO", "TSU", "BOT", "GAS", "MAG", "SAR"], voltaRapida: "RUS" },
                "Grande Pr√™mio de Miami": { grid: ["VER", "PER", "ALO", "RUS", "SAI", "HAM", "LEC", "GAS", "MAG", "TSU", "STR", "BOT", "ALB", "HUL", "ZHO", "NOR", "SAR"], voltaRapida: "VER" },
                "Grande Pr√™mio de M√¥naco": { grid: ["VER", "ALO", "HAM", "RUS", "LEC", "GAS", "SAI", "NOR", "TSU", "PIA", "BOT", "HUL", "ZHO", "ALB", "MAG", "PER", "SAR", "STR"], voltaRapida: "HAM" },
                "Grande Pr√™mio da Espanha": { grid: ["VER", "HAM", "RUS", "PER", "SAI", "STR", "ALO", "ZHO", "TSU", "PIA", "LEC", "GAS", "HUL", "BOT", "MAG", "NOR", "SAR"], voltaRapida: "VER" },
                "Grande Pr√™mio do Canad√°": { grid: ["VER", "ALO", "HAM", "LEC", "SAI", "PER", "ALB", "STR", "BOT", "PIA", "GAS", "NOR", "TSU", "HUL", "ZHO", "DEV", "MAG", "SAR", "RUS"], voltaRapida: "PER" },
                "Grande Pr√™mio da √Åustria": { sprint: ["VER", "PER", "SAI", "STR", "ALO", "HUL", "RUS", "GAS"], grid: ["VER", "LEC", "PER", "NOR", "ALO", "SAI", "RUS", "HAM", "STR", "GAS", "ALB", "ZHO", "SAR", "BOT", "PIA", "TSU", "MAG"], voltaRapida: "VER" },
                "Grande Pr√™mio da Gr√£-Bretanha": { grid: ["VER", "NOR", "HAM", "PIA", "RUS", "PER", "ALO", "ALB", "LEC", "SAI", "SAR", "BOT", "HUL", "STR", "ZHO", "TSU", "GAS", "MAG"], voltaRapida: "VER" },
                "Grande Pr√™mio da Hungria": { grid: ["VER", "NOR", "PER", "HAM", "PIA", "RUS", "LEC", "SAI", "ALO", "STR", "BOT", "HUL", "RIC", "ZHO", "ALB", "MAG", "SAR", "TSU"], voltaRapida: "VER" },
                "Grande Pr√™mio da B√©lgica": { sprint: ["VER", "PIA", "GAS", "SAI", "LEC", "NOR", "RUS", "HAM"], grid: ["VER", "PER", "LEC", "HAM", "ALO", "RUS", "NOR", "STR", "TSU", "BOT", "GAS", "ZHO", "ALB", "MAG", "RIC", "SAR", "HUL"], voltaRapida: "HAM" },
                "Grande Pr√™mio dos Pa√≠ses Baixos": { grid: ["VER", "ALO", "GAS", "PER", "SAI", "HAM", "NOR", "ALB", "PIA", "STR", "BOT", "TSU", "RUS", "MAG", "HUL", "ZHO", "SAR", "LEC"], voltaRapida: "ALO" },
                "Grande Pr√™mio da It√°lia": { grid: ["VER", "PER", "SAI", "LEC", "RUS", "HAM", "ALB", "NOR", "BOT", "PIA", "SAR", "LAW", "ZHO", "GAS", "STR", "HUL", "MAG"], voltaRapida: "PIA" },
                "Grande Pr√™mio de Singapura": { grid: ["SAI", "NOR", "HAM", "LEC", "VER", "GAS", "PIA", "PER", "LAW", "MAG", "ALB", "HUL", "ZHO", "BOT", "ALO", "RUS", "TSU"], voltaRapida: "HAM" },
                "Grande Pr√™mio do Jap√£o": { grid: ["VER", "NOR", "PIA", "LEC", "HAM", "SAI", "RUS", "ALO", "GAS", "LAW", "TSU", "ZHO", "MAG", "HUL", "BOT", "STR", "ALB", "SAR"], voltaRapida: "VER" },
                "Grande Pr√™mio do Catar": { sprint: ["PIA", "VER", "NOR", "RUS", "SAI", "LEC", "ALO", "ALB"], grid: ["VER", "PIA", "NOR", "RUS", "LEC", "ALO", "BOT", "ZHO", "PER", "GAS", "STR", "TSU", "ALB", "MAG", "HUL", "HAM", "SAI", "SAR"], voltaRapida: "VER" },
                "Grande Pr√™mio dos Estados Unidos": { sprint: ["VER", "HAM", "LEC", "NOR", "PER", "SAI", "GAS", "RUS"], grid: ["VER", "NOR", "SAI", "PER", "RUS", "GAS", "STR", "TSU", "ALB", "SAR", "HUL", "RIC", "ZHO", "BOT", "MAG", "ALO"], voltaRapida: "TSU" },
                "Grande Pr√™mio do M√©xico": { grid: ["VER", "HAM", "LEC", "SAI", "NOR", "RUS", "RIC", "PIA", "ALB", "GAS", "HUL", "TSU", "ZHO", "BOT", "SAR", "STR", "PER", "MAG"], voltaRapida: "HAM" },
                "Grande Pr√™mio de S√£o Paulo": { sprint: ["VER", "NOR", "PER", "RUS", "LEC", "TSU", "HAM", "SAI"], grid: ["VER", "NOR", "ALO", "PER", "STR", "SAI", "GAS", "HAM", "TSU", "PIA", "RUS", "RIC", "HUL", "ZHO", "BOT", "MAG", "SAR", "LEC", "ALB"], voltaRapida: "NOR" },
                "Grande Pr√™mio de Las Vegas": { grid: ["VER", "LEC", "PER", "STR", "SAI", "HAM", "RUS", "ALO", "PIA", "GAS", "ALB", "MAG", "RIC", "ZHO", "SAR", "BOT", "TSU", "HUL"], voltaRapida: "PIA" },
                "Grande Pr√™mio de Abu Dhabi": { grid: ["VER", "LEC", "RUS", "PER", "NOR", "PIA", "ALO", "TSU", "HAM", "STR", "RIC", "GAS", "ALB", "HUL", "SAR", "ZHO", "SAI", "BOT", "MAG"], voltaRapida: "VER" }
            };

            const temporadaSelect = document.getElementById("temporada"), grandePremioSelect = document.getElementById("grandePremio"), adicionarResultadoBtn = document.getElementById("adicionarResultadoBtn"), statsSelector = document.getElementById('stats-selector'), infoDisplayCard = document.getElementById('info-display-card'), fichaTecnicaContainer = document.getElementById('ficha-tecnica-container'), teamStatsContainer = document.getElementById('team-stats-container');
            const gpStatsModal = document.getElementById('gpStatsModal'), gpTitle = document.getElementById('gpTitle'), gpStats = document.getElementById('gpStats');
            const classificacaoModal = document.getElementById('classificacaoModal'), classificacaoModalContainer = document.getElementById('classificacaoModalContainer');
            const raceGridModal = document.getElementById('raceGridModal'), raceGridModalContainer = document.getElementById('raceGridModalContainer'), raceGridTitle = document.getElementById('raceGridTitle');
            const resultadosContainer = document.getElementById("resultadosContainer");

            function calculateAge(birthDateString) { const [day, month, year] = birthDateString.split('/'); const birthDate = new Date(+year, +month - 1, +day); const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--; return age; }
            
            function displayFichaTecnica() { 
                const pilotInfo = { name: "Fernando Lapa", nationality: "Brasileiro", birthDate: "18/02/2005", birthPlace: "Florian√≥polis, SC" }; 
                const teamsList = Object.keys(teamData)
                    .sort((a,b) => b-a)
                    .map(year => `<li><i class="fas fa-users"></i> ${year}:<span class="value">${teamData[year].name}</span></li>`)
                    .join(''); 
                fichaTecnicaContainer.innerHTML = `<div class="stats-card"><h3><i class="fas fa-id-card"></i> Ficha T√©cnica</h3><ul><li><i class="fas fa-user"></i> Nome: <span class="value">${pilotInfo.name}</span></li><li><i class="fas fa-flag"></i> Nacionalidade: <span class="value">${pilotInfo.nationality}</span></li><li><i class="fas fa-birthday-cake"></i> Nascimento: <span class="value">${pilotInfo.birthDate} (${calculateAge(pilotInfo.birthDate)} anos)</span></li><li><i class="fas fa-map-marker-alt"></i> Naturalidade: <span class="value">${pilotInfo.birthPlace}</span></li></ul><h3 style="margin-top: 20px;"><i class="fas fa-history"></i> Hist√≥rico de Equipes</h3><ul>${teamsList}</ul></div>`; 
            }
            
            async function displayTeamStats() {
                if (!db) return;
                teamStatsContainer.innerHTML = `<p style="text-align: center;">Calculando estat√≠sticas...</p>`;
                try {
                    const allRacesSnapshot = await db.collection("corridas").get();
                    const aggregatedStats = {};
                    allRacesSnapshot.forEach(doc => {
                        const race = doc.data(); const teamInfo = teamData[race.temporada];
                        if (!teamInfo) return;
                        if (!aggregatedStats[teamInfo.name]) { aggregatedStats[teamInfo.name] = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0, titulos: 0, temporadas: 0, latestYear: 0 }; }
                        const stats = aggregatedStats[teamInfo.name];
                        stats.latestYear = Math.max(stats.latestYear, parseInt(race.temporada));
                        stats.corridas++; if (race.posicao === 1) stats.vitorias++; if (race.posicao >= 1 && race.posicao <= 3) stats.podios++; if (race.pole) stats.poles++; if (race.voltaMaisRapida) stats.voltasMaisRapidas++; if (race.grandSlam) stats.grandSlams++;
                    });
                    const teamYears = {};
                    for (const year in teamData) {
                        const teamName = teamData[year].name;
                        if (!teamYears[teamName]) teamYears[teamName] = [];
                        teamYears[teamName].push(year);
                    }
                    const statsPromises = Object.keys(corridas).map(year => db.doc(`estatisticas/temporada_${year}`).get());
                    const statsDocs = await Promise.all(statsPromises);
                    const seasonTitles = {};
                    statsDocs.forEach(doc => {
                        if (doc.exists) {
                            const year = doc.id.split('_')[1];
                            seasonTitles[year] = doc.data().titulos || 0;
                        }
                    });
                    for (const teamName in aggregatedStats) {
                        const seasonsWithTeam = teamYears[teamName] || [];
                        aggregatedStats[teamName].temporadas = seasonsWithTeam.length;
                        let totalTitles = 0;
                        for (const year of seasonsWithTeam) {
                            if (seasonTitles[year]) { totalTitles += seasonTitles[year]; }
                        }
                        aggregatedStats[teamName].titulos = totalTitles;
                    }
                    let html = '';
                    const calcPct = (val, total) => total > 0 ? `(${(val / total * 100).toFixed(1)}%)` : '';
                    const sortedTeamNames = Object.keys(aggregatedStats).sort((a, b) => aggregatedStats[b].latestYear - aggregatedStats[a].latestYear);
                    for (const teamName of sortedTeamNames) {
                        const stats = aggregatedStats[teamName];
                        let titulosPctTeam = "0.0";
                        if (stats.titulos > 0 && stats.temporadas > 0) {
                            titulosPctTeam = ((stats.titulos / stats.temporadas) * 100).toFixed(1);
                        }
                        html += `<div class="card stats-card"><h3>${teamName}</h3>
                            <p><i class="fas fa-calendar-alt"></i> Temporadas: <span class="value">${stats.temporadas}</span></p>
                            <p><i class="fas fa-flag-checkered"></i> Corridas: <span class="value">${stats.corridas}</span></p>
                            <p><i class="fas fa-trophy"></i> Vit√≥rias: <span class="value">${stats.vitorias} ${calcPct(stats.vitorias, stats.corridas)}</span></p>
                            <p><i class="fas fa-star"></i> P√≥dios: <span class="value">${stats.podios} ${calcPct(stats.podios, stats.corridas)}</span></p>
                            <p><i class="fas fa-award"></i> T√≠tulos: <span class="value">${stats.titulos} (${titulosPctTeam}%)</span></p>
                            <p><i class="fas fa-tachometer-alt"></i> Poles: <span class="value">${stats.poles} ${calcPct(stats.poles, stats.corridas)}</span></p>
                            <p><i class="fas fa-stopwatch"></i> V. R√°pidas: <span class="value">${stats.voltasMaisRapidas} ${calcPct(stats.voltasMaisRapidas, stats.corridas)}</span></p>
                            <p><i class="fas fa-crown"></i> Grand Slams: <span class="value">${stats.grandSlams} ${calcPct(stats.grandSlams, stats.corridas)}</span></p></div>`;
                    }
                    teamStatsContainer.innerHTML = html || '<p style="text-align: center;">Sem dados de equipe para exibir.</p>';
                } catch (error) { console.error("Erro ao exibir estat√≠sticas da equipe:", error); teamStatsContainer.innerHTML = `<p style="text-align: center;">Erro ao carregar os dados das equipes.</p>`; }
            }

            function populateSelectors() {
                const anos = [...Object.keys(corridas)].sort((a,b) => b-a);
                temporadaSelect.innerHTML = '';
                anos.forEach(ano => { const option = document.createElement("option"); option.value = ano; option.textContent = ano; temporadaSelect.appendChild(option); });
                statsSelector.innerHTML = '<option value="carreira">Carreira</option>';
                anos.forEach(ano => { const option = document.createElement("option"); option.value = ano; option.textContent = `Temporada ${ano}`; statsSelector.appendChild(option); });
            }

            async function displaySelectedStats() {
                if (!db) return;
                const selection = statsSelector.value;
                let docPath, title;
                if (selection === 'carreira') { docPath = 'estatisticas/carreira'; title = 'Carreira'; } else { docPath = `estatisticas/temporada_${selection}`; title = `Temporada ${selection}`; }
                infoDisplayCard.innerHTML = `<p>Carregando...</p>`;
                try {
                    const doc = await db.doc(docPath).get();
                    if (doc.exists) {
                        const stats = doc.data();
                        let totalSeasons = Object.keys(corridas).length;
                        let titulosPct = "0.0";
                        if (stats.titulos > 0) { titulosPct = (selection === 'carreira') ? (stats.titulos / totalSeasons * 100).toFixed(1) : (stats.titulos / 1 * 100).toFixed(1); }
                        infoDisplayCard.innerHTML = `<h3>${title}</h3>
                            <p><i class="fas fa-flag-checkered"></i> Corridas: <span class="value">${stats.corridas || 0}</span></p>
                            <p><i class="fas fa-trophy"></i> Vit√≥rias: <span class="value">${stats.vitorias || 0} (${stats.vitoriasPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-star"></i> P√≥dios: <span class="value">${stats.podios || 0} (${stats.podiosPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-tachometer-alt"></i> Poles: <span class="value">${stats.poles || 0} (${stats.polesPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-stopwatch"></i> V. R√°pidas: <span class="value">${stats.voltasMaisRapidas || 0} (${stats.voltasMaisRapidasPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-crown"></i> Grand Slams: <span class="value">${stats.grandSlams || 0} (${stats.grandSlamsPct || '0.0'}%)</span></p>
                            <p><i class="fas fa-award"></i> T√≠tulos: <span class="value">${stats.titulos || 0} (${titulosPct}%)</span></p>`;
                    } else { infoDisplayCard.innerHTML = `<h3>${title}</h3><p>Sem dados dispon√≠veis.</p>`; }
                } catch (error) { console.error("Erro ao buscar estat√≠sticas:", error); infoDisplayCard.innerHTML = `<h3>${title}</h3><p>Erro ao carregar estat√≠sticas.</p>`; }
            }
            
            function preencherGrandesPremios() {
                const temporada = temporadaSelect.value;
                grandePremioSelect.innerHTML = '<option value="">Selecione um GP</option>';
                if (corridas[temporada]) corridas[temporada].forEach(corrida => { const option = document.createElement("option"); option.value = corrida.nome; option.textContent = corrida.nome; grandePremioSelect.appendChild(option); });
                carregarResultadosDaTemporada();
                handleClassificacaoButton();
            }
            
            async function carregarResultadosDaTemporada() {
                if (!db) return;
                const temporada = temporadaSelect.value;
                resultadosContainer.innerHTML = `<p style="padding: 20px 0; text-align: center;">Carregando resultados...</p>`;
                try {
                    const corridasSnapshot = await db.collection("corridas").where("temporada", "==", temporada).get();
                    const resultadosFirestore = [];
                    const nomesCorridasFirestore = new Set();
                    corridasSnapshot.forEach(doc => {
                        const data = doc.data();
                        resultadosFirestore.push(data);
                        nomesCorridasFirestore.add(data.grandePremio);
                    });
                    resultadosFirestore.sort((a, b) => {
                        const raceDateA = corridas[temporada]?.find(r => r.nome === a.grandePremio)?.data || 0;
                        const raceDateB = corridas[temporada]?.find(r => r.nome === b.grandePremio)?.data || 0;
                        return new Date(raceDateA) - new Date(raceDateB);
                    });
                    let htmlSalvos = '';
                    let htmlProximas = '';
                    if (resultadosFirestore.length > 0) {
                       htmlSalvos += '<h3 class="subsection-title">Resultados Salvos</h3>';
                        resultadosFirestore.forEach(dados => {
                            const nomeCurto = dados.grandePremio.replace(/^(Grande Pr√™mio|GP) d(o|a|e|os|as)\s/, '');
                            const flagCode = countryFlags[nomeCurto] || 'xx';
                            let posicaoClass = '';
                            if (dados.posicao === 1) posicaoClass = 'podium-gold'; else if (dados.posicao === 2) posicaoClass = 'podium-silver'; else if (dados.posicao === 3) posicaoClass = 'podium-bronze'; else if (dados.posicao === "N/C") posicaoClass = 'not-completed';
                            htmlSalvos += `
                                <div class="race-card clickable" data-gp="${dados.grandePremio}">
                                    <div class="race-header">
                                        <div class="race-header-title"><img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"> ${dados.grandePremio}</div>
                                        ${temporada === '2023' ? `<button class="ver-resultado-btn" data-gp="${dados.grandePremio}">Resultado Completo</button>` : ''}
                                    </div>
                                    <div class="race-details">
                                        <div class="detail-item"><strong>Pos.</strong><span class="value posicao-col ${posicaoClass}">${dados.posicao}</span></div>
                                        <div class="detail-item"><strong>Pole</strong><span class="value">${dados.pole ? '<i class="fas fa-check" style="color: var(--secondary-color);"></i>' : '-'}</span></div>
                                        <div class="detail-item"><strong>V. R√°pida</strong><span class="value">${dados.voltaMaisRapida ? '<i class="fas fa-check" style="color: var(--secondary-color);"></i>' : '-'}</span></div>
                                        <div class="detail-item"><button class="delete-btn" data-temporada="${dados.temporada}" data-gp="${dados.grandePremio}"><i class="fas fa-trash"></i> Remover</button></div>
                                    </div>
                                </div>`;
                        });
                    }
                    const calendarioTemporada = corridas[temporada] || [];
                    let temProximas = false;
                    calendarioTemporada.forEach(corrida => {
                        if (!nomesCorridasFirestore.has(corrida.nome)) {
                            if(!temProximas) {
                                htmlProximas += '<h3 class="subsection-title">Corridas Futuras</h3>';
                                temProximas = true;
                            }
                            const nomeCurto = corrida.nome.replace(/^(Grande Pr√™mio|GP) d(o|a|e|os|as)\s/, '');
                            const flagCode = countryFlags[nomeCurto] || 'xx';
                            htmlProximas += `
                                <div class="race-card clickable" data-gp="${corrida.nome}">
                                    <div class="race-header">
                                        <div class="race-header-title"><img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"> ${corrida.nome}</div>
                                        ${temporada === '2023' ? `<button class="ver-resultado-btn" data-gp="${corrida.nome}">Resultado Completo</button>` : ''}
                                    </div>
                                </div>`;
                        }
                    });
                    resultadosContainer.innerHTML = htmlSalvos + htmlProximas;
                    if(resultadosContainer.innerHTML === "") { resultadosContainer.innerHTML = "<p style='padding: 20px 0; text-align: center;'>Nenhuma corrida encontrada para esta temporada.</p>"; }
                    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const { temporada, gp } = e.currentTarget.dataset; excluirResultado(temporada, gp); }));
                    document.querySelectorAll('.ver-resultado-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); displayRaceGrid(e.currentTarget.dataset.gp); }));
                    document.querySelectorAll('.race-card.clickable').forEach(card => card.addEventListener('click', (e) => { if (!e.target.closest('button')) { mostrarEstatisticasGP(e.currentTarget.dataset.gp); }}));
                } catch (error) { console.error("Erro Cr√≠tico ao carregar resultados:", error); resultadosContainer.innerHTML = `<p>Erro ao carregar dados.</p>`; }
            }

            async function mostrarEstatisticasGP(grandePremio) {
                const nomeCurto = grandePremio.replace(/^(Grande Pr√™mio|GP) d(o|a|e|os|as)\s/, '');
                const flagCode = countryFlags[nomeCurto] || 'xx';
                gpTitle.innerHTML = `<img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"> Estat√≠sticas em ${grandePremio}`;
                gpStats.innerHTML = `<p>Buscando hist√≥rico...</p>`;
                gpStatsModal.classList.add("open");
                try {
                    const gpSnapshot = await db.collection('corridas').where('grandePremio', '==', grandePremio).get();
                    if (gpSnapshot.empty) {
                        gpStats.innerHTML = `<p>Nenhum resultado de Fernando Lapa registrado para esta corrida em nenhuma temporada.</p>`;
                        return;
                    }
                    let stats = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0 };
                    let historyHtml = '<h3>Hist√≥rico de Resultados</h3>';
                    gpSnapshot.docs.sort((a,b) => a.data().temporada.localeCompare(b.data().temporada)).forEach(doc => {
                        const d = doc.data();
                        stats.corridas++;
                        if (d.posicao === 1) stats.vitorias++;
                        if (d.posicao >= 1 && d.posicao <= 3) stats.podios++;
                        if (d.pole) stats.poles++;
                        if (d.voltaMaisRapida) stats.voltasMaisRapidas++;
                        if (d.grandSlam) stats.grandSlams++;
                        historyHtml += `<p>${d.temporada}: <span class="value">Posi√ß√£o ${d.posicao}</span></p>`;
                    });
                    const summaryHtml = `
                        <h3>Resumo da Carreira no GP</h3>
                        <p><i class="fas fa-flag-checkered"></i> Corridas: <span class="value">${stats.corridas}</span></p>
                        <p><i class="fas fa-trophy"></i> Vit√≥rias: <span class="value">${stats.vitorias}</span></p>
                        <p><i class="fas fa-star"></i> P√≥dios: <span class="value">${stats.podios}</span></p>
                        <p><i class="fas fa-tachometer-alt"></i> Poles: <span class="value">${stats.poles}</span></p>
                        <p><i class="fas fa-stopwatch"></i> V. R√°pidas: <span class="value">${stats.voltasMaisRapidas}</span></p>
                        <p><i class="fas fa-crown"></i> Grand Slams: <span class="value">${stats.grandSlams}</span></p>`;
                    gpStats.innerHTML = summaryHtml + '<hr style="margin: 20px 0; border-color: var(--border-color);">' + historyHtml;
                } catch (error) { console.error("Erro ao buscar estat√≠sticas do GP:", error); gpStats.innerHTML = `<p>Erro ao carregar estat√≠sticas do GP.</p>`; }
            }

            function handleClassificacaoButton(){
                const temporada = temporadaSelect.value;
                const botaoContainer = document.getElementById('classificacao-botao-container');
                if (temporada === '2023') {
                    botaoContainer.innerHTML = `<button id="verClassificacaoBtn"><i class="fas fa-trophy"></i> Ver Classifica√ß√£o Final 2023</button>`;
                    document.getElementById('verClassificacaoBtn').addEventListener('click', async () => {
                        classificacaoModalContainer.innerHTML = `<p style="text-align:center; padding: 20px;">Calculando...</p>`;
                        classificacaoModal.classList.add('open');
                        const classificacaoFinal = await gerarClassificacaoFinal2023();
                        displayClassificacaoInModal(classificacaoFinal);
                    });
                } else {
                    botaoContainer.innerHTML = '';
                }
            }

            async function gerarClassificacaoFinal2023() {
                if (!db) return [];
                const pontosPorPosicao = { 1: 25, 2: 18, 3: 15, 4: 12, 5: 10, 6: 8, 7: 6, 8: 4, 9: 2, 10: 1 };
                let lapaTotalPoints = 0;
                const snapshot2023 = await db.collection("corridas").where("temporada", "==", "2023").get();
                snapshot2023.forEach(doc => {
                    const corrida = doc.data();
                    if (corrida.posicao && corrida.posicao <= 10) {
                        lapaTotalPoints += pontosPorPosicao[corrida.posicao] || 0;
                        if (corrida.voltaMaisRapida) { lapaTotalPoints += 1; }
                    }
                });
                let classificacaoFinal = [];
                classificacaoFinal.push({ pos: 1, piloto: "Fernando Lapa", equipe: "Alpine", pontos: lapaTotalPoints });
                let verstappenPontos = classificacaoReal2023.find(p => p.piloto === "Max Verstappen").pontos;
                if (verstappenPontos >= lapaTotalPoints) { verstappenPontos = lapaTotalPoints - 18; }
                classificacaoFinal.push({ pos: 2, piloto: "Max Verstappen", equipe: "Red Bull", pontos: verstappenPontos });
                let currentPos = 3;
                classificacaoReal2023.forEach(piloto => {
                    if (piloto.piloto !== "Max Verstappen") {
                        const equipe = Object.values(pilotos2023).find(p => p.nome === piloto.piloto)?.equipe || "N/A";
                        classificacaoFinal.push({ pos: currentPos, piloto: piloto.piloto, equipe: equipe, pontos: piloto.pontos });
                        currentPos++;
                    }
                });
                return classificacaoFinal;
            }

            function displayClassificacaoInModal(classificacaoData) {
                let html = `
                    <table style="width: 100%;">
                        <thead><tr>
                            <th style="width: 50px; text-align: center;">Pos.</th>
                            <th>Pa√≠s</th>
                            <th>Piloto</th>
                            <th>Equipe</th>
                            <th style="text-align: right;">Pontos</th>
                        </tr></thead><tbody>`;
                classificacaoData.forEach(piloto => {
                    const isLapa = piloto.piloto === "Fernando Lapa";
                    const destaqueClass = isLapa ? "destaque-piloto" : "";
                    const flagCode = pilotoNacionalidade[piloto.piloto] || 'xx';
                    html += `<tr class="${destaqueClass}">
                        <td style="text-align: center; font-weight: bold; font-size: 1.1rem;">${piloto.pos}</td>
                        <td><img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"></td>
                        <td>${piloto.piloto}</td>
                        <td>${piloto.equipe}</td>
                        <td style="text-align: right; font-weight: bold; font-size: 1.1rem;">${piloto.pontos}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                classificacaoModalContainer.innerHTML = html;
            }

            async function displayRaceGrid(grandePremio) {
                raceGridModal.classList.add('open');
                const nomeCurto = grandePremio.replace(/^(Grande Pr√™mio|GP) d(o|a|e|os|as)\s/, '');
                const flagCode = countryFlags[nomeCurto] || 'xx';
                raceGridTitle.innerHTML = `<img src="https://flagcdn.com/w40/${flagCode}.png" class="flag">Resultado - ${grandePremio}`;
                raceGridModalContainer.innerHTML = `<p>Gerando simula√ß√£o...</p>`;
                
                const resultadoReal = resultadosReais2023[grandePremio];
                if(!resultadoReal) {
                    raceGridModalContainer.innerHTML = `<p>Dados de simula√ß√£o n√£o encontrados para esta corrida.</p>`;
                    return;
                }

                let lapaResult = null;
                try {
                    const doc = await db.collection("corridas").doc(`2023_${grandePremio}`).get();
                    if(doc.exists) lapaResult = doc.data();
                } catch(e) { console.error("Erro ao buscar resultado de Lapa:", e); }

                let gridFinal = [...resultadoReal.grid];
                if(lapaResult && lapaResult.posicao !== 'N/C' && lapaResult.posicao > 0){
                    gridFinal.splice(lapaResult.posicao - 1, 0, 'LAP');
                } else {
                    gridFinal.push('LAP');
                }

                const pontosPorPosicao = { 1: 25, 2: 18, 3: 15, 4: 12, 5: 10, 6: 8, 7: 6, 8: 4, 9: 2, 10: 1 };
                let html = `<table style="width: 100%;"><thead><tr><th>Pos.</th><th>Pa√≠s</th><th>Piloto</th><th>Equipe</th><th style="text-align:right;">Pontos</th></tr></thead><tbody>`;
                gridFinal.slice(0, 20).forEach((pilotoAbbr, index) => {
                    const pos = index + 1;
                    const pilotoInfo = pilotos2023[pilotoAbbr];
                    if(!pilotoInfo) return;

                    let pontos = pontosPorPosicao[pos] || 0;
                    if(resultadoReal.voltaRapida === pilotoAbbr && pos <= 10) pontos++;
                    
                    const isLapa = pilotoInfo.nome === "Fernando Lapa";
                    const destaqueClass = isLapa ? "destaque-piloto" : "";
                    const flagCode = pilotoNacionalidade[pilotoInfo.nome] || 'xx';
                    
                    html += `<tr class="${destaqueClass}">
                        <td style="text-align:center; font-weight:bold;">${lapaResult && isLapa && lapaResult.posicao === 'N/C' ? 'DNF' : pos}</td>
                        <td><img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"></td>
                        <td>${pilotoInfo.nome}</td>
                        <td>${pilotoInfo.equipe}</td>
                        <td style="text-align:right;">${lapaResult && isLapa && lapaResult.posicao === 'N/C' ? '0' : pontos}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                
                if(resultadoReal.sprint) {
                    html += '<h3 class="subsection-title" style="margin-top: 25px;">Resultado da Sprint Race</h3>';
                    html += `<table style="width: 100%;"><thead><tr><th>Pos.</th><th>Pa√≠s</th><th>Piloto</th><th style="text-align:right;">Pontos</th></tr></thead><tbody>`;
                    resultadoReal.sprint.forEach((pilotoAbbr, index) => {
                        const pilotoInfo = pilotos2023[pilotoAbbr];
                        const pontosSprint = 8 - index;
                        const flagCode = pilotoNacionalidade[pilotoInfo.nome] || 'xx';
                        html += `<tr>
                            <td style="text-align:center; font-weight:bold;">${index + 1}</td>
                            <td><img src="https://flagcdn.com/w40/${flagCode}.png" class="flag"></td>
                            <td>${pilotoInfo.nome}</td>
                            <td style="text-align:right;">${pontosSprint}</td>
                        </tr>`;
                    });
                     html += `</tbody></table>`;
                }

                raceGridModalContainer.innerHTML = html;
            }

            function limparFormulario() { document.getElementById("posicao").value = ""; document.getElementById("pole").checked = false; document.getElementById("voltaMaisRapida").checked = false; document.getElementById("grandSlam").checked = false; document.getElementById("titulos").value = ""; }
            async function adicionarResultado() {
                const temporada = temporadaSelect.value, grandePremio = grandePremioSelect.value, posicaoInput = document.getElementById("posicao").value, posicao = posicaoInput ? parseInt(posicaoInput) : "N/C", pole = document.getElementById("pole").checked, voltaMaisRapida = document.getElementById("voltaMaisRapida").checked, grandSlam = document.getElementById("grandSlam").checked, titulos = document.getElementById("titulos").value !== "" ? parseInt(document.getElementById("titulos").value) : null;
                if (!temporada || !grandePremio) { alert("Selecione uma temporada e um GP."); return; }
                const dadosCorrida = { temporada, grandePremio, posicao, pole, voltaMaisRapida, grandSlam };
                if (!db) return;
                try { 
                    await db.collection("corridas").doc(`${temporada}_${grandePremio}`).set(dadosCorrida); 
                    await atualizarEstatisticas(temporada, titulos); 
                    limparFormulario(); 
                    carregarResultadosDaTemporada(); 
                    displaySelectedStats(); 
                    displayTeamStats();
                } catch (error) { console.error("Erro ao adicionar resultado:", error); alert("Falha ao adicionar resultado."); }
            }
            async function excluirResultado(temporada, grandePremio) {
                if (!db) return;
                if (confirm(`Deseja excluir o resultado de ${grandePremio} (${temporada})?`)) { 
                    try { 
                        await db.collection("corridas").doc(`${temporada}_${grandePremio}`).delete(); 
                        await atualizarEstatisticas(temporada, null); 
                        carregarResultadosDaTemporada(); 
                        displaySelectedStats(); 
                        displayTeamStats(); 
                    } catch (error) { console.error("Erro ao excluir resultado:", error); alert("Falha ao excluir resultado."); } 
                }
            }
            async function atualizarEstatisticas(temporada, titulos) {
                if (!db) return;
                try {
                    const corridasSnapshot = await db.collection("corridas").where("temporada", "==", temporada).get();
                    let estac = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0, titulos: 0 };
                    corridasSnapshot.forEach(doc => { const d = doc.data(); estac.corridas++; if (d.posicao === 1) estac.vitorias++; if (d.posicao >= 1 && d.posicao <= 3) estac.podios++; if (d.pole) estac.poles++; if (d.voltaMaisRapida) estac.voltasMaisRapidas++; if(d.grandSlam) estac.grandSlams++; });
                    if (titulos !== null) { estac.titulos = titulos; } else { const statsDoc = await db.collection("estatisticas").doc(`temporada_${temporada}`).get(); if (statsDoc.exists) estac.titulos = statsDoc.data().titulos || 0; }
                    const calcPct = (val, total) => total > 0 ? ((val / total) * 100).toFixed(1) : "0.0";
                    estac.vitoriasPct = calcPct(estac.vitorias, estac.corridas); estac.podiosPct = calcPct(estac.podios, estac.corridas); estac.polesPct = calcPct(estac.poles, estac.corridas); estac.voltasMaisRapidasPct = calcPct(estac.voltasMaisRapidas, estac.corridas); estac.grandSlamsPct = calcPct(estac.grandSlams, estac.corridas);
                    await db.collection("estatisticas").doc(`temporada_${temporada}`).set(estac, { merge: true });
                    const todasCorridas = await db.collection("corridas").get();
                    let estacCarreira = { corridas: 0, vitorias: 0, podios: 0, poles: 0, voltasMaisRapidas: 0, grandSlams: 0, titulos: 0 };
                    let titulosCarreira = 0;
                    todasCorridas.forEach(doc => { const d = doc.data(); estacCarreira.corridas++; if (d.posicao === 1) estacCarreira.vitorias++; if (d.posicao >= 1 && d.posicao <= 3) estacCarreira.podios++; if (d.pole) estacCarreira.poles++; if (d.voltaMaisRapida) estacCarreira.voltasMaisRapidas++; if(d.grandSlam) estacCarreira.grandSlams++; });
                    for (const temp of Object.keys(corridas)) { const temporadaDoc = await db.collection("estatisticas").doc(`temporada_${temp}`).get(); if (temporadaDoc.exists) titulosCarreira += temporadaDoc.data().titulos || 0; }
                    estacCarreira.titulos = titulosCarreira;
                    estacCarreira.vitoriasPct = calcPct(estacCarreira.vitorias, estacCarreira.corridas); estacCarreira.podiosPct = calcPct(estacCarreira.podios, estacCarreira.corridas); estacCarreira.polesPct = calcPct(estacCarreira.poles, estacCarreira.corridas); estacCarreira.voltasMaisRapidasPct = calcPct(estacCarreira.voltasMaisRapidas, estacCarreira.corridas); estacCarreira.grandSlamsPct = calcPct(estacCarreira.grandSlams, estacCarreira.corridas);
                    await db.collection("estatisticas").doc("carreira").set(estacCarreira, { merge: true });
                } catch (error) { console.error("Erro ao atualizar estat√≠sticas:", error); }
            }
            
            document.querySelectorAll('.modal .close-btn').forEach(btn => btn.addEventListener('click', () => {
                btn.closest('.modal').classList.remove('open');
            }));
            window.addEventListener('click', (e) => { 
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('open');
                }
            });

            // INICIALIZA√á√ÉO DA P√ÅGINA
            displayFichaTecnica(); 
            populateSelectors(); 
            preencherGrandesPremios(); 
            displaySelectedStats(); 
            displayTeamStats();
            
            // LISTENERS DE EVENTOS
            temporadaSelect.addEventListener("change", preencherGrandesPremios);
            adicionarResultadoBtn.addEventListener("click", adicionarResultado);
            statsSelector.addEventListener('change', displaySelectedStats);
        });
    </script>
</body>
</html>

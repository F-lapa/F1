<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas de F. Lapa - F1</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://www.formula1.com/favicon.ico" type="image/x-icon">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(135deg, #1a1a2e, #0f0f1f);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow-x: hidden;
            position: relative;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8), rgba(15, 15, 31, 0.8));
        }

        .container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            padding: 15px;
        }

        h1 {
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            color: #ff2d55;
            text-shadow: 0 0 10px rgba(255, 45, 85, 0.8), 0 0 20px rgba(255, 45, 85, 0.5);
            font-size: 3rem;
            margin: 20px 0 40px;
            letter-spacing: 3px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            animation: neonGlow 1.8s ease-in-out infinite alternate;
        }

        @keyframes neonGlow {
            from { text-shadow: 0 0 8px rgba(255, 45, 85, 0.7), 0 0 15px rgba(255, 45, 85, 0.4); }
            to { text-shadow: 0 0 12px rgba(255, 45, 85, 0.9), 0 0 25px rgba(255, 45, 85, 0.6); }
        }

        .flag-br, .f1-logo {
            width: 35px;
            border-radius: 5px;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .flag-br:hover, .f1-logo:hover {
            transform: scale(1.2) rotate(2deg);
            filter: brightness(1.3) drop-shadow(0 0 5px rgba(255, 45, 85, 0.5));
        }

        .form-container {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95), rgba(50, 50, 70, 0.95));
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 45, 85, 0.4);
        }

        .form-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(255, 45, 85, 0.3);
        }

        .form-container h2 {
            font-family: 'Orbitron', sans-serif;
            color: #00d4ff;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .form-container select, .form-container input[type="number"] {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #ff2d55;
            border-radius: 6px;
            background: rgba(20, 20, 40, 0.95);
            color: #ffffff;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-container select:focus, .form-container input[type="number"]:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            outline: none;
        }

        .form-container label {
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #e0e0e0;
            margin: 6px 0;
        }

        .form-container button {
            background: linear-gradient(45deg, #ff2d55, #ff6b8b);
            color: #ffffff;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .form-container button:hover {
            background: linear-gradient(45deg, #e60039, #ff4d6d);
            box-shadow: 0 0 12px rgba(255, 45, 85, 0.6);
            transform: scale(1.03);
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
            color: #00d4ff;
            font-size: 1.6rem;
            margin: 20px 0;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .table-container {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95), rgba(50, 50, 70, 0.95));
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            margin-bottom: 30px;
            border: 1px solid rgba(255, 45, 85, 0.4);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #ffffff;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.95rem;
        }

        th {
            background: linear-gradient(45deg, #ff2d55, #ff6b8b);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
        }

        tr:nth-child(even) {
            background: rgba(20, 20, 40, 0.5);
        }

        tr:hover {
            background: rgba(255, 45, 85, 0.2);
            transform: translateX(3px);
            transition: all 0.3s ease;
        }

        .flag {
            width: 22px;
            vertical-align: middle;
            margin-right: 6px;
            border-radius: 3px;
            transition: transform 0.3s ease;
        }

        .flag:hover {
            transform: scale(1.2);
        }

        .delete-btn {
            background: linear-gradient(45deg, #e60039, #ff4d6d);
            color: #ffffff;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: linear-gradient(45deg, #cc0033, #e60039);
            box-shadow: 0 0 10px rgba(255, 45, 85, 0.5);
            transform: scale(1.05);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95), rgba(50, 50, 70, 0.95));
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0, 212, 255, 0.4);
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 212, 255, 0.3);
        }

        .stats-card h3 {
            font-family: 'Orbitron', sans-serif;
            color: #00d4ff;
            font-size: 1.6rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            text-align: center;
        }

        .stats-card p {
            margin: 10px 0;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-card p span.percentage {
            color: #00d4ff;
            margin-left: 6px;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .modal-content {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95), rgba(50, 50, 70, 0.95));
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            max-width: 450px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 45, 85, 0.4);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            font-family: 'Orbitron', sans-serif;
            color: #00d4ff;
            font-size: 1.6rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-content .gp-flag {
            width: 50px;
            border-radius: 6px;
            animation: waveFlag 1.8s ease-in-out infinite;
        }

        @keyframes waveFlag {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(3deg); }
        }

        .modal-content .stats-list p {
            background: rgba(20, 20, 40, 0.5);
            padding: 8px;
            border-radius: 5px;
            font-size: 0.95rem;
            margin: 6px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(40, 40, 60, 0.8);
            color: #ff2d55;
            border: 1px solid #ff2d55;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #ff2d55;
            color: #ffffff;
            box-shadow: 0 0 8px rgba(255, 45, 85, 0.6);
        }

        /* Media Queries para Responsividade */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
                gap: 8px;
            }

            .flag-br, .f1-logo {
                width: 30px;
            }

            .form-container, .stats-card {
                padding: 20px;
            }

            .form-container h2, .stats-card h3, h2 {
                font-size: 1.4rem;
            }

            th, td {
                padding: 10px;
                font-size: 0.85rem;
            }

            .delete-btn {
                padding: 5px 8px;
                font-size: 0.8rem;
            }

            .stats-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .modal-content {
                padding: 20px;
                max-width: 85%;
            }

            .modal-content .gp-flag {
                width: 40px;
            }

            .modal-content h3 {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
                flex-direction: column;
                gap: 6px;
                margin: 15px 0 30px;
            }

            .flag-br, .f1-logo {
                width: 25px;
            }

            .form-container h2, .stats-card h3, h2 {
                font-size: 1.2rem;
            }

            .form-container select, .form-container input[type="number"], .form-container button {
                font-size: 0.85rem;
                padding: 8px;
            }

            .form-container label {
                font-size: 0.85rem;
            }

            th, td {
                padding: 8px;
                font-size: 0.75rem;
            }

            .modal-content {
                padding: 15px;
            }

            .modal-content .gp-flag {
                width: 35px;
            }

            .modal-content h3 {
                font-size: 1.2rem;
            }

            .modal-content .stats-list p {
                font-size: 0.85rem;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="container">
        <h1>
            <img src="https://flagcdn.com/w20/br.png" class="flag-br" alt="Bandeira do Brasil">
            Estatísticas de F. Lapa - F1
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/33/F1.svg" class="f1-logo" alt="Fórmula 1 Logo">
        </h1>
        <div class="form-container">
            <h2><i class="fas fa-flag-checkered"></i> Adicionar Resultado de Corrida</h2>
            <select id="temporada">
                <option value="2023">2023</option>
                <option value="2024" selected>2024</option>
            </select>
            <select id="grandePremio"></select>
            <input type="number" id="posicao" placeholder="Posição (1-20)" min="1" max="20">
            <label><input type="checkbox" id="pole"> <i class="fas fa-tachometer-alt"></i> Pole Position</label>
            <label><input type="checkbox" id="voltaMaisRapida"> <i class="fas fa-stopwatch"></i> Volta Mais Rápida</label>
            <label><input type="checkbox" id="grandSlam"> <i class="fas fa-trophy"></i> Grand Slam</label>
            <input type="number" id="titulos" placeholder="Títulos Mundiais (Manual)" min="0">
            <button id="adicionarResultadoBtn"><i class="fas fa-plus-circle"></i> Adicionar Resultado</button>
        </div>
        <h2><i class="fas fa-list"></i> Resultados das Corridas</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Temporada</th>
                        <th>Grande Prêmio</th>
                        <th>Data</th>
                        <th>Posição</th>
                        <th>Pole</th>
                        <th>Volta Mais Rápida</th>
                        <th>Grand Slam</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="resultadosBody"></tbody>
            </table>
        </div>
        <h2><i class="fas fa-chart-bar"></i> Estatísticas</h2>
        <div class="stats-container">
            <div class="stats-card" id="statsTemporada"></div>
            <div class="stats-card" id="carreiraStats"></div>
        </div>
    </div>

    <div id="gpModal" class="modal">
        <div class="modal-content">
            <button class="close-btn"><i class="fas fa-times"></i></button>
            <h3 id="gpTitle"></h3>
            <div class="stats-list" id="gpStats"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        particlesJS('particles-js', {
            particles: {
                number: { value: 120, density: { enable: true, value_area: 800 } },
                color: { value: ['#ff2d55', '#00d4ff', '#ffd700'] },
                shape: { type: ['circle', 'triangle'], stroke: { width: 0 } },
                opacity: { value: 0.6, random: true },
                size: { value: 3, random: true },
                line_linked: { enable: false },
                move: { enable: true, speed: 2, direction: 'none', random: true }
            },
            interactivity: {
                detect_on: 'canvas',
                events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' } },
                modes: { repulse: { distance: 80, duration: 0.3 }, push: { particles_nb: 3 } }
            },
            retina_detect: true
        });

        document.addEventListener("DOMContentLoaded", () => {
            const firebaseConfig = {
                apiKey: "AIzaSyA0OlEixa0paaC8w5vwXr3d8bdXHsTsk6Q",
                authDomain: "formula1-7ddf0.firebaseapp.com",
                projectId: "formula1-7ddf0",
                storageBucket: "formula1-7ddf0.firebasestorage.app",
                messagingSenderId: "1033180811650",
                appId: "1:1033180811650:web:9e315520430b36e4e8ff9b",
                measurementId: "G-Q8LEND18DW"
            };

            let db;
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("Firebase inicializado com sucesso.");
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                alert("Erro ao conectar com o banco de dados. Verifique o console.");
            }

            const countryFlags = {
                "Grande Prêmio do Bahrein": "https://flagcdn.com/w20/bh.png",
                "Grande Prêmio da Arábia Saudita": "https://flagcdn.com/w20/sa.png",
                "Grande Prêmio da Austrália": "https://flagcdn.com/w20/au.png",
                "Grande Prêmio do Azerbaijão": "https://flagcdn.com/w20/az.png",
                "Grande Prêmio de Miami": "https://flagcdn.com/w20/us.png",
                "Grande Prêmio de Mônaco": "https://flagcdn.com/w20/mc.png",
                "Grande Prêmio da Espanha": "https://flagcdn.com/w20/es.png",
                "Grande Prêmio do Canadá": "https://flagcdn.com/w20/ca.png",
                "Grande Prêmio da Áustria": "https://flagcdn.com/w20/at.png",
                "Grande Prêmio da Grã-Bretanha": "https://flagcdn.com/w20/gb.png",
                "Grande Prêmio da Hungria": "https://flagcdn.com/w20/hu.png",
                "Grande Prêmio da Bélgica": "https://flagcdn.com/w20/be.png",
                "Grande Prêmio dos Países Baixos": "https://flagcdn.com/w20/nl.png",
                "Grande Prêmio da Itália": "https://flagcdn.com/w20/it.png",
                "Grande Prêmio de Singapura": "https://flagcdn.com/w20/sg.png",
                "Grande Prêmio do Japão": "https://flagcdn.com/w20/jp.png",
                "Grande Prêmio do Catar": "https://flagcdn.com/w20/qa.png",
                "Grande Prêmio dos Estados Unidos": "https://flagcdn.com/w20/us.png",
                "Grande Prêmio do México": "https://flagcdn.com/w20/mx.png",
                "Grande Prêmio de São Paulo": "https://flagcdn.com/w20/br.png",
                "Grande Prêmio de Las Vegas": "https://flagcdn.com/w20/us.png",
                "Grande Prêmio de Abu Dhabi": "https://flagcdn.com/w20/ae.png",
                "Grande Prêmio da China": "https://flagcdn.com/w20/cn.png",
                "Grande Prêmio da Emília-Romanha": "https://flagcdn.com/w20/it.png"
            };

            const corridas = {
                "2023": [
                    { nome: "Grande Prêmio do Bahrein", data: "2023-03-05" },
                    { nome: "Grande Prêmio da Arábia Saudita", data: "2023-03-19" },
                    { nome: "Grande Prêmio da Austrália", data: "2023-04-02" },
                    { nome: "Grande Prêmio do Azerbaijão", data: "2023-04-30" },
                    { nome: "Grande Prêmio de Miami", data: "2023-05-07" },
                    { nome: "Grande Prêmio de Mônaco", data: "2023-05-28" },
                    { nome: "Grande Prêmio da Espanha", data: "2023-06-04" },
                    { nome: "Grande Prêmio do Canadá", data: "2023-06-18" },
                    { nome: "Grande Prêmio da Áustria", data: "2023-07-02" },
                    { nome: "Grande Prêmio da Grã-Bretanha", data: "2023-07-09" },
                    { nome: "Grande Prêmio da Hungria", data: "2023-07-23" },
                    { nome: "Grande Prêmio da Bélgica", data: "2023-07-30" },
                    { nome: "Grande Prêmio dos Países Baixos", data: "2023-08-27" },
                    { nome: "Grande Prêmio da Itália", data: "2023-09-03" },
                    { nome: "Grande Prêmio de Singapura", data: "2023-09-17" },
                    { nome: "Grande Prêmio do Japão", data: "2023-09-24" },
                    { nome: "Grande Prêmio do Catar", data: "2023-10-08" },
                    { nome: "Grande Prêmio dos Estados Unidos", data: "2023-10-22" },
                    { nome: "Grande Prêmio do México", data: "2023-10-29" },
                    { nome: "Grande Prêmio de São Paulo", data: "2023-11-05" },
                    { nome: "Grande Prêmio de Las Vegas", data: "2023-11-18" },
                    { nome: "Grande Prêmio de Abu Dhabi", data: "2023-11-26" }
                ],
                "2024": [
                    { nome: "Grande Prêmio do Bahrein", data: "2024-03-02" },
                    { nome: "Grande Prêmio da Arábia Saudita", data: "2024-03-09" },
                    { nome: "Grande Prêmio da Austrália", data: "2024-03-24" },
                    { nome: "Grande Prêmio do Japão", data: "2024-04-07" },
                    { nome: "Grande Prêmio da China", data: "2024-04-21" },
                    { nome: "Grande Prêmio de Miami", data: "2024-05-05" },
                    { nome: "Grande Prêmio da Emília-Romanha", data: "2024-05-19" },
                    { nome: "Grande Prêmio de Mônaco", data: "2024-05-26" },
                    { nome: "Grande Prêmio do Canadá", data: "2024-06-09" },
                    { nome: "Grande Prêmio da Espanha", data: "2024-06-23" },
                    { nome: "Grande Prêmio da Áustria", data: "2024-06-30" },
                    { nome: "Grande Prêmio da Grã-Bretanha", data: "2024-07-07" },
                    { nome: "Grande Prêmio da Hungria", data: "2024-07-21" },
                    { nome: "Grande Prêmio da Bélgica", data: "2024-07-28" },
                    { nome: "Grande Prêmio dos Países Baixos", data: "2024-08-25" },
                    { nome: "Grande Prêmio da Itália", data: "2024-09-01" },
                    { nome: "Grande Prêmio do Azerbaijão", data: "2024-09-15" },
                    { nome: "Grande Prêmio de Singapura", data: "2024-09-22" },
                    { nome: "Grande Prêmio dos Estados Unidos", data: "2024-10-20" },
                    { nome: "Grande Prêmio do México", data: "2024-10-27" },
                    { nome: "Grande Prêmio de São Paulo", data: "2024-11-03" },
                    { nome: "Grande Prêmio de Las Vegas", data: "2024-11-23" },
                    { nome: "Grande Prêmio do Catar", data: "2024-12-01" },
                    { nome: "Grande Prêmio de Abu Dhabi", data: "2024-12-08" }
                ]
            };

            const temporadaSelect = document.getElementById("temporada");
            const grandePremioSelect = document.getElementById("grandePremio");
            const modal = document.getElementById("gpModal");
            const modalTitle = document.getElementById("gpTitle");
            const modalStats = document.getElementById("gpStats");
            const closeBtn = document.querySelector(".close-btn");

            function preencherGrandesPremios() {
                const temporada = temporadaSelect.value;
                grandePremioSelect.innerHTML = '<option value="">Selecione um Grande Prêmio</option>';
                if (corridas[temporada]) {
                    corridas[temporada].forEach(corrida => {
                        const option = document.createElement("option");
                        option.value = corrida.nome;
                        option.textContent = corrida.nome;
                        grandePremioSelect.appendChild(option);
                    });
                } else {
                    console.error(`Erro: temporada ${temporada} não encontrada.`);
                    alert("Erro ao carregar os Grandes Prêmios.");
                }
                carregarResultados();
            }

            temporadaSelect.addEventListener("change", preencherGrandesPremios);
            preencherGrandesPremios();

            const adicionarResultadoBtn = document.getElementById("adicionarResultadoBtn");
            adicionarResultadoBtn.addEventListener("click", adicionarResultado);

            async function adicionarResultado() {
                const temporada = temporadaSelect.value;
                const grandePremio = grandePremioSelect.value;
                const posicao = parseInt(document.getElementById("posicao").value);
                let pole = document.getElementById("pole").checked;
                let voltaMaisRapida = document.getElementById("voltaMaisRapida").checked;
                let grandSlam = document.getElementById("grandSlam").checked;
                const titulos = parseInt(document.getElementById("titulos").value) || 0;

                if (!temporada || !grandePremio) {
                    alert("Selecione uma temporada e um Grande Prêmio.");
                    limparFormulario();
                    return;
                }
                if (!posicao || posicao < 1 || posicao > 20) {
                    alert("Insira uma posição válida (1 a 20).");
                    limparFormulario();
                    return;
                }

                if (grandSlam && (posicao !== 1 || !pole || !voltaMaisRapida)) {
                    alert("Grand Slam requer 1º lugar, pole position e volta mais rápida.");
                    limparFormulario();
                    return;
                }

                const dadosCorrida = {
                    temporada,
                    grandePremio,
                    data: corridas[temporada].find(c => c.nome === grandePremio).data,
                    posicao,
                    pole,
                    voltaMaisRapida,
                    grandSlam
                };

                if (!db) {
                    alert("Erro: Banco de dados não inicializado.");
                    limparFormulario();
                    return;
                }

                try {
                    await db.collection("corridas").doc(`${temporada}_${grandePremio}`).set(dadosCorrida);
                    await atualizarEstatisticas(temporada, titulos);
                    alert("Resultado adicionado com sucesso!");
                    carregarResultados();
                    limparFormulario();
                } catch (error) {
                    console.error("Erro ao adicionar resultado:", error);
                    alert("Erro ao adicionar resultado: " + error.message);
                }
            }

            function limparFormulario() {
                document.getElementById("posicao").value = "";
                document.getElementById("pole").checked = false;
                document.getElementById("voltaMaisRapida").checked = false;
                document.getElementById("grandSlam").checked = false;
                document.getElementById("titulos").value = "";
            }

            async function excluirResultado(temporada, grandePremio) {
                if (!db) {
                    alert("Erro: Banco de dados não inicializado.");
                    return;
                }
                if (confirm(`Deseja excluir o resultado de ${grandePremio} (${temporada})?`)) {
                    try {
                        await db.collection("corridas").doc(`${temporada}_${grandePremio}`).delete();
                        await atualizarEstatisticas(temporada, 0);
                        alert("Resultado excluído com sucesso!");
                        carregarResultados();
                    } catch (error) {
                        console.error("Erro ao excluir resultado:", error);
                        alert("Erro ao excluir resultado: " + error.message);
                    }
                }
            }

            async function atualizarEstatisticas(temporada, titulos) {
                if (!db) {
                    alert("Erro: Banco de dados não inicializado.");
                    return;
                }

                try {
                    // Estatísticas da temporada
                    const corridasSnapshot = await db.collection("corridas").where("temporada", "==", temporada).get();
                    let estatisticas = {
                        corridas: 0,
                        vitorias: 0,
                        podios: 0,
                        poles: 0,
                        voltasMaisRapidas: 0,
                        hatTricks: 0,
                        grandSlams: 0,
                        titulos
                    };

                    corridasSnapshot.forEach(doc => {
                        const dados = doc.data();
                        estatisticas.corridas++;
                        if (dados.posicao === 1) estatisticas.vitorias++;
                        if (dados.posicao <= 3 && dados.posicao >= 1) estatisticas.podios++;
                        if (dados.pole) estatisticas.poles++;
                        if (dados.voltaMaisRapida) estatisticas.voltasMaisRapidas++;
                        if (dados.posicao === 1 && dados.pole && dados.voltaMaisRapida) estatisticas.hatTricks++;
                        if (dados.grandSlam) estatisticas.grandSlams++;
                    });

                    // Cálculo das porcentagens com verificação de divisão por zero
                    estatisticas.vitoriasPct = estatisticas.corridas > 0 ? ((estatisticas.vitorias / estatisticas.corridas) * 100).toFixed(1) : "0.0";
                    estatisticas.podiosPct = estatisticas.corridas > 0 ? ((estatisticas.podios / estatisticas.corridas) * 100).toFixed(1) : "0.0";
                    estatisticas.polesPct = estatisticas.corridas > 0 ? ((estatisticas.poles / estatisticas.corridas) * 100).toFixed(1) : "0.0";
                    estatisticas.voltasMaisRapidasPct = estatisticas.corridas > 0 ? ((estatisticas.voltasMaisRapidas / estatisticas.corridas) * 100).toFixed(1) : "0.0";
                    estatisticas.hatTricksPct = estatisticas.corridas > 0 ? ((estatisticas.hatTricks / estatisticas.corridas) * 100).toFixed(1) : "0.0";
                    estatisticas.grandSlamsPct = estatisticas.corridas > 0 ? ((estatisticas.grandSlams / estatisticas.corridas) * 100).toFixed(1) : "0.0";
                    estatisticas.titulosPct = estatisticas.titulos > 0 ? ((estatisticas.titulos / 2) * 100).toFixed(1) : "0.0"; // Baseado em 2 temporadas

                    await db.collection("estatisticas").doc(`temporada_${temporada}`).set(estatisticas, { merge: true });

                    // Estatísticas da carreira
                    const todasCorridas = await db.collection("corridas").get();
                    let estatisticasCarreira = {
                        corridas: 0,
                        vitorias: 0,
                        podios: 0,
                        poles: 0,
                        voltasMaisRapidas: 0,
                        hatTricks: 0,
                        grandSlams: 0,
                        titulos: 0
                    };

                    todasCorridas.forEach(doc => {
                        const dados = doc.data();
                        estatisticasCarreira.corridas++;
                        if (dados.posicao === 1) estatisticasCarreira.vitorias++;
                        if (dados.posicao <= 3 && dados.posicao >= 1) estatisticasCarreira.podios++;
                        if (dados.pole) estatisticasCarreira.poles++;
                        if (dados.voltaMaisRapida) estatisticasCarreira.voltasMaisRapidas++;
                        if (dados.posicao === 1 && dados.pole && dados.voltaMaisRapida) estatisticasCarreira.hatTricks++;
                        if (dados.grandSlam) estatisticasCarreira.grandSlams++;
                    });

                    const temporadas = ["2023", "2024"];
                    for (const temp of temporadas) {
                        const temporadaDoc = await db.collection("estatisticas").doc(`temporada_${temp}`).get();
                        if (temporadaDoc.exists) {
                            estatisticasCarreira.titulos += temporadaDoc.data().titulos || 0;
                        }
                    }

                    // Cálculo das porcentagens da carreira
                    estatisticasCarreira.vitoriasPct = estatisticasCarreira.corridas > 0 ? ((estatisticasCarreira.vitorias / estatisticasCarreira.corridas) * 100).toFixed(1) : "0.0";
                    estatisticasCarreira.podiosPct = estatisticasCarreira.corridas > 0 ? ((estatisticasCarreira.podios / estatisticasCarreira.corridas) * 100).toFixed(1) : "0.0";
                    estatisticasCarreira.polesPct = estatisticasCarreira.corridas > 0 ? ((estatisticasCarreira.poles / estatisticasCarreira.corridas) * 100).toFixed(1) : "0.0";
                    estatisticasCarreira.voltasMaisRapidasPct = estatisticasCarreira.corridas > 0 ? ((estatisticasCarreira.voltasMaisRapidas / estatisticasCarreira.corridas) * 100).toFixed(1) : "0.0";
                    estatisticasCarreira.hatTricksPct = estatisticasCarreira.corridas > 0 ? ((estatisticasCarreira.hatTricks / estatisticasCarreira.corridas) * 100).toFixed(1) : "0.0";
                    estatisticasCarreira.grandSlamsPct = estatisticasCarreira.corridas > 0 ? ((estatisticasCarreira.grandSlams / estatisticasCarreira.corridas) * 100).toFixed(1) : "0.0";
                    estatisticasCarreira.titulosPct = estatisticasCarreira.titulos > 0 ? ((estatisticasCarreira.titulos / 2) * 100).toFixed(1) : "0.0";

                    await db.collection("estatisticas").doc("carreira").set(estatisticasCarreira, { merge: true });
                } catch (error) {
                    console.error("Erro ao atualizar estatísticas:", error);
                    alert("Erro ao atualizar estatísticas: " + error.message);
                }
            }

            async function mostrarEstatisticasGP(grandePremio) {
                if (!db) {
                    alert("Erro: Banco de dados não inicializado.");
                    return;
                }

                try {
                    const corridasSnapshot = await db.collection("corridas").where("grandePremio", "==", grandePremio).get();
                    let stats = {
                        corridas: 0,
                        vitorias: 0,
                        podios: 0,
                        poles: 0,
                        voltasMaisRapidas: 0,
                        hatTricks: 0,
                        grandSlams: 0
                    };

                    corridasSnapshot.forEach(doc => {
                        const dados = doc.data();
                        stats.corridas++;
                        if (dados.posicao === 1) stats.vitorias++;
                        if (dados.posicao <= 3 && dados.posicao >= 1) stats.podios++;
                        if (dados.pole) stats.poles++;
                        if (dados.voltaMaisRapida) stats.voltasMaisRapidas++;
                        if (dados.posicao === 1 && dados.pole && dados.voltaMaisRapida) stats.hatTricks++;
                        if (dados.grandSlam) stats.grandSlams++;
                    });

                    // Cálculo das porcentagens para o modal
                    stats.vitoriasPct = stats.corridas > 0 ? ((stats.vitorias / stats.corridas) * 100).toFixed(1) : "0.0";
                    stats.podiosPct = stats.corridas > 0 ? ((stats.podios / stats.corridas) * 100).toFixed(1) : "0.0";
                    stats.polesPct = stats.corridas > 0 ? ((stats.poles / stats.corridas) * 100).toFixed(1) : "0.0";
                    stats.voltasMaisRapidasPct = stats.corridas > 0 ? ((stats.voltasMaisRapidas / stats.corridas) * 100).toFixed(1) : "0.0";
                    stats.hatTricksPct = stats.corridas > 0 ? ((stats.hatTricks / stats.corridas) * 100).toFixed(1) : "0.0";
                    stats.grandSlamsPct = stats.corridas > 0 ? ((stats.grandSlams / stats.corridas) * 100).toFixed(1) : "0.0";

                    modalTitle.innerHTML = countryFlags[grandePremio]
                        ? `<img src="${countryFlags[grandePremio]}" class="gp-flag" alt="Bandeira do GP"> ${grandePremio}`
                        : grandePremio;
                    modalStats.innerHTML = `
                        <p><i class="fas fa-flag-checkered"></i> Corridas: ${stats.corridas}</p>
                        <p><i class="fas fa-trophy"></i> Vitórias: ${stats.vitorias} <span class="percentage">(${stats.vitoriasPct}%)</span></p>
                        <p><i class="fas fa-star"></i> Pódios: ${stats.podios} <span class="percentage">(${stats.podiosPct}%)</span></p>
                        <p><i class="fas fa-tachometer-alt"></i> Pole Positions: ${stats.poles} <span class="percentage">(${stats.polesPct}%)</span></p>
                        <p><i class="fas fa-stopwatch"></i> Voltas Mais Rápidas: ${stats.voltasMaisRapidas} <span class="percentage">(${stats.voltasMaisRapidasPct}%)</span></p>
                        <p><i class="fas fa-medal"></i> Hat-tricks: ${stats.hatTricks} <span class="percentage">(${stats.hatTricksPct}%)</span></p>
                        <p><i class="fas fa-crown"></i> Grand Slams: ${stats.grandSlams} <span class="percentage">(${stats.grandSlamsPct}%)</span></p>
                    `;
                    modal.style.display = "flex";
                } catch (error) {
                    console.error("Erro ao carregar estatísticas do GP:", error);
                    alert("Erro ao carregar estatísticas do GP: " + error.message);
                }
            }

            closeBtn.addEventListener("click", () => {
                modal.style.display = "none";
            });

            window.addEventListener("click", (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });

            async function carregarResultados() {
                if (!db) {
                    alert("Erro: Banco de dados não inicializado.");
                    return;
                }

                const temporada = temporadaSelect.value;
                const resultadosBody = document.getElementById("resultadosBody");
                resultadosBody.innerHTML = '<tr><td colspan="8">Carregando...</td></tr>';

                try {
                    const corridasSnapshot = await db.collection("corridas").where("temporada", "==", temporada).orderBy("data").get();

                    resultadosBody.innerHTML = "";
                    corridasSnapshot.forEach(doc => {
                        const dados = doc.data();
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${dados.temporada}</td>
                            <td><img src="${countryFlags[dados.grandePremio] || ''}" class="flag" alt="Bandeira"> ${dados.grandePremio}</td>
                            <td>${dados.data}</td>
                            <td>${dados.posicao}</td>
                            <td>${dados.pole ? "Sim" : "Não"}</td>
                            <td>${dados.voltaMaisRapida ? "Sim" : "Não"}</td>
                            <td>${dados.grandSlam ? "Sim" : "Não"}</td>
                            <td><button class="delete-btn"><i class="fas fa-trash"></i> Excluir</button></td>
                        `;
                        resultadosBody.appendChild(row);

                        row.addEventListener("click", (e) => {
                            if (!e.target.closest(".delete-btn")) {
                                mostrarEstatisticasGP(dados.grandePremio);
                            }
                        });

                        const deleteBtn = row.querySelector(".delete-btn");
                        deleteBtn.addEventListener("click", () => excluirResultado(dados.temporada, dados.grandePremio));
                    });

                    const statsDoc = await db.collection("estatisticas").doc(`temporada_${temporada}`).get();
                    const statsDiv = document.getElementById("statsTemporada");
                    if (statsDoc.exists) {
                        const stats = statsDoc.data();
                        statsDiv.innerHTML = `
                            <h3>Temporada ${temporada}</h3>
                            <p><i class="fas fa-flag-checkered"></i> Corridas: ${stats.corridas}</p>
                            <p><i class="fas fa-trophy"></i> Vitórias: ${stats.vitorias} <span class="percentage">(${stats.vitoriasPct}%)</span></p>
                            <p><i class="fas fa-star"></i> Pódios: ${stats.podios} <span class="percentage">(${stats.podiosPct}%)</span></p>
                            <p><i class="fas fa-tachometer-alt"></i> Pole Positions: ${stats.poles} <span class="percentage">(${stats.polesPct}%)</span></p>
                            <p><i class="fas fa-stopwatch"></i> Voltas Mais Rápidas: ${stats.voltasMaisRapidas} <span class="percentage">(${stats.voltasMaisRapidasPct}%)</span></p>
                            <p><i class="fas fa-medal"></i> Hat-tricks: ${stats.hatTricks} <span class="percentage">(${stats.hatTricksPct}%)</span></p>
                            <p><i class="fas fa-crown"></i> Grand Slams: ${stats.grandSlams} <span class="percentage">(${stats.grandSlamsPct}%)</span></p>
                            <p><i class="fas fa-award"></i> Título Máximo: ${stats.titulos} <span class="percentage">(${stats.titulosPct}%)</span></p>
                        `;
                    } else {
                        statsDiv.innerHTML = `<h3>Temporada ${temporada}</h3><p>Sem dados disponíveis.</p>`;
                    }

                    const carreiraDoc = await db.collection("estatisticas").doc("carreira").get();
                    const carreiraStatsCarreiraDiv = document.getElementById("carreiraStats");
                    if (carreiraDoc.exists) {
                        const stats = carreiraDoc.data();
                        carreiraStatsCarreiraDiv.innerHTML = `
                            <h3>Carreira</h3>
                            <p><i class="fas fa-flag-checkered"></i> Corridas: ${stats.corridas}</p>
                            <p><i class="fas fa-trophy"></i> Vitórias: ${stats.vitorias} <span class="percentage">(${stats.vitoriasPct}%)</span></p>
                            <p><i class="fas fa-star"></i> Pódios: ${stats.podios} <span class="percentage">(${stats.podiosPct}%)</span></p>
                            <p><i class="fas fa-tachometer-alt"></i> Pole Positions: ${stats.poles} <span class="percentage">(${stats.polesPct}%)</span></p>
                            <p><i class="fas fa-stopwatch"></i> Voltas Mais Rápidas: ${stats.voltasMaisRapidas} <span class="percentage">(${stats.voltasMaisRapidasPct}%)</span></p>
                            <p><i class="fas fa-medal"></i> Hat-tricks: ${stats.hatTricks} <span class="percentage">(${stats.hatTricksPct}%)</span></p>
                            <p><i class="fas fa-crown"></i> Grand Slams: ${stats.grandSlams} <span class="percentage">(${stats.grandSlamsPct}%)</span></p>
                            <p><i class="fas fa-award"></i> Títulos Máximos: ${stats.titulos} <span class="percentage">(${stats.titulosPct}%)</span></p>
                        `;
                    } else {
                        carreiraStatsCarreiraDiv.innerHTML = "<h3>Carreira</h3><p>Sem dados disponíveis.</p>";
                    }
                } catch (error) {
                    console.error("Erro ao carregar resultados:", error);
                    alert("Erro ao carregar resultados: " + error.message);
                    resultadosBody.innerHTML = '<tr><td colspan="8">Erro ao carregar resultados.</td></tr>';
                }
            }

            carregarResultados();
        });
    </script>
</body>
</html>
